<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brothers EGY - Contract System v76.0 (Perfect UI)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ================= SCREEN UI (Clean & Optimized) ================= */
        :root {
            --primary: #04509D;
            --secondary: #333;
            --bg: #eef2f5;
            --accent: #e67e22;
            --success: #27ae60;
            --danger: #c0392b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 10px 20px;
            color: #333;
        }

        /* FLOATING PILL HEADER */
        .floating-header {
            max-width: 1050px;
            margin: 10px auto 20px auto;
            background: white;
            border: 3px solid var(--primary);
            border-radius: 50px;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .rate-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .badge-live {
            background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px;
            font-size: 8px; font-weight: bold; text-transform: uppercase;
        }

        .live-clock {
            font-family: monospace; font-weight: bold; font-size: 13px; color: var(--primary);
        }

        .rate-input {
            width: 70px !important; font-weight: bold; color: #000; text-align: center;
            border: 1px solid #ccc !important; height: 26px !important; border-radius: 4px; font-size: 12px !important;
        }

        /* MAIN CONTROL PANEL */
        .control-panel {
            max-width: 1050px; /* Constrained width for perfect readability */
            margin: 0 auto 40px auto;
            background: transparent;
        }

        .cp-body {
            background: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        /* FORM ELEMENTS & GRIDS */
        .section-head {
            font-size: 14px; font-weight: 800; color: var(--secondary); text-transform: uppercase;
            margin: 25px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #eee;
        }
        .section-head:first-child { margin-top: 0; }

        label { display: block; font-size: 10px; font-weight: 700; color: #555; margin-bottom: 4px; text-transform: uppercase; }

        input, select {
            width: 100%; box-sizing: border-box; padding: 0 12px; height: 40px; font-size: 13px;
            border: 1px solid #ccc; border-radius: 5px; transition: 0.2s;
        }
        select { cursor: pointer; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(4, 80, 157, 0.1); }

        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 12px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 12px; }

        .phone-group { display: flex; gap: 5px; }
        .phone-group input:first-child { width: 70px; text-align: center; flex-shrink: 0; }
        .phone-group input:last-child { flex: 1; }

        /* MONEY & BALANCES */
        .balance-box {
            background: #2c3e50; color: white; padding: 20px; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%; box-sizing: border-box;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        .bal-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 3px; }

        .btn-print {
            background: var(--primary); color: white; border: none; padding: 18px; width: 100%;
            font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 25px;
            display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.3s; text-transform: uppercase;
        }
        .btn-print:hover { background: #033a75; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }

        /* INSURANCE HIGHLIGHTS */
        .ins-basic { background-color: #ffebee !important; border: 2px solid #c0392b !important; color: #c0392b !important; }
        .ins-inter { background-color: #fff3e0 !important; border: 2px solid #e67e22 !important; color: #e67e22 !important; }
        .ins-full { background-color: #e8f5e9 !important; border: 2px solid #27ae60 !important; color: #27ae60 !important; }

        /* ================= VISUAL INSPECTION (SCREEN & PRINT) ================= */
        .car-img-container { width: 100%; aspect-ratio: 960/618; display: flex; align-items: center; justify-content: center; margin-bottom: 2px; }
        .car-img-container img { width: 100%; height: 100%; object-fit: contain; }
        .tire-img-wrapper { display: flex; align-items: center; gap: 5px; justify-content: center; margin-top: 2px; }
        .tire-img-container { height: 50px; aspect-ratio: 219/350; display: flex; align-items: center; justify-content: center; }
        .tire-img-container img { width: 100%; height: 100%; object-fit: contain; }

        .insp-two-col { display: flex; width: 100%; height: 100%; }
        .insp-left-col { width: 50%; border-right: 1px dashed #000; padding-right: 10px; display: flex; flex-direction: column; }
        .insp-right-col { width: 50%; padding-left: 10px; display: flex; flex-direction: column; }
        
        .insp-section-head { background: #eee; font-weight: bold; padding: 5px; text-align: center; font-size: 9pt; border-bottom: 1px solid #000; margin-bottom: 5px; }
        .insp-group-head { background: #000; color: #fff; font-weight: bold; font-size: 7pt; padding: 2px 4px; margin-top: 5px; margin-bottom: 2px; text-transform: uppercase; border-radius: 2px; }
        
        .v-insp-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px; font-size: 7pt; border-bottom: 1px dotted #ccc; padding-bottom: 1px; }
        .v-label { font-weight: bold; font-size: 6.5pt; text-transform: uppercase; }
        .v-check-box { width: 10px; height: 10px; border: 1.5px solid #333; margin-left: 3px; display: inline-block; }
        .v-green { border-color: #27ae60; }
        .v-red { border-color: #c0392b; }

        /* ================= PRINT STYLES ================= */
        #print-container, #contractOutput { display: none; }

        @media print {
            body { background: white; margin: 0; padding: 0; visibility: hidden; }
            .floating-header, .control-panel, .btn-print { display: none !important; }
            
            #contractOutput { visibility: visible; display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
            #contractOutput * { visibility: visible; }

            @page { margin: 0; size: A4; }
            
            .a4-page {
                width: 210mm; min-height: 297mm; padding: 12mm; margin: 0 auto;
                background: white; position: relative; box-sizing: border-box;
                font-family: 'Helvetica', 'Arial', sans-serif; font-size: 9.5pt; line-height: 1.35; color: #000;
                display: flex; flex-direction: column; page-break-after: always; box-shadow: none; border: none;
            }
            .a4-page:last-child { page-break-after: auto; }

            .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 75%; opacity: 0.05; z-index: 0; pointer-events: none; }
            .watermark img { width: 100%; height: auto; }
            .page-content { position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column; }

            /* Headers & Boxes */
            .doc-head { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 15px; }
            .logo { width: 180px; height: auto; object-fit: contain; }
            .hq-info { font-size: 8pt; color: #555; line-height: 1.4; text-align: right; }

            .box-section { border: 1px solid #000; padding: 8px; margin-bottom: 12px; position: relative; }
            .bs-title { background: #000; color: white; padding: 2px 8px; font-weight: bold; font-size: 8pt; position: absolute; top: -10px; left: -1px; text-transform: uppercase; }
            
            .pt { width: 100%; border-collapse: collapse; font-size: 9pt; margin-bottom: 5px; }
            .pt th, .pt td { border: 1px solid #000; padding: 4px; text-align: left; vertical-align: middle; }
            .pt th { background: #f0f0f0; text-align: center; font-weight: bold; }

            /* Terms */
            .terms-grid { font-size: 9.5pt; text-align: justify; column-count: 2; column-gap: 30px; line-height: 1.4; flex-grow: 1; }
            .term-p { margin-bottom: 12px; break-inside: avoid; }
            .term-h { font-weight: 800; text-transform: uppercase; display: block; margin-bottom: 3px; border-bottom: 1px solid #999; padding-bottom: 2px; font-size: 10pt; color: var(--primary); }

            /* RECEIPTS - EXACT ALIGNMENT */
            .receipt-half {
                height: 48%; border: 2px solid #000; padding: 15px; display: flex; flex-direction: column;
                position: relative; box-sizing: border-box; background: white; margin-bottom: 0;
            }
            .rec-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
            .rec-logo { height: 45px; }
            .rec-title { font-size: 16pt; font-weight: bold; text-transform: uppercase; color: var(--primary); }
            
            .rec-body-grid { display: flex; gap: 20px; font-size: 9pt; line-height: 1.6; border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }
            .rec-col { flex: 1; display: flex; flex-direction: column; gap: 4px; }
            .rec-row { display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; }
            .rec-label { font-weight: bold; color: #555; text-transform: uppercase; font-size: 8.5pt; }
            .rec-val { font-weight: bold; color: #000; text-align: right; }

            .rec-amount-box { border: 1px solid #ccc; background: #fbfbfb; padding: 10px 15px; margin-bottom: 5px; }
            .rec-amount-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
            .rec-amount-lbl { font-weight: bold; color: #555; font-size: 10pt; text-transform: uppercase; }
            .rec-amount-val { font-size: 18pt; font-weight: bold; color: #000; }
            
            .rec-sig-line { border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 5px; font-size: 9pt; font-weight: bold; }
        }
    </style>
</head>

<body>

    <div class="floating-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <img src="https://brothersegy.com/wp-content/uploads/2026/02/12345.png" style="height:40px;">
            <h2 style="margin:0; color:var(--primary); font-size:18px;">Smart Contract v76.0</h2>
        </div>
        <div style="display:flex; gap:20px; align-items:center;">
            <div class="rate-group">
                <i class="fa-regular fa-clock" style="color:var(--primary);"></i>
                <div id="clock" class="live-clock">--:--:--</div>
            </div>
            <div class="rate-group">
                <div style="font-size:10px; font-weight:bold; color:#555;">USD <span class="badge-live">LIVE</span></div>
                <input type="number" id="ex_usd" class="rate-input" value="50.00" oninput="calc()">
            </div>
            <div class="rate-group">
                <div style="font-size:10px; font-weight:bold; color:#555;">EUR <span class="badge-live">LIVE</span></div>
                <input type="number" id="ex_eur" class="rate-input" value="54.00" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div class="cp-body">

            <div class="section-head">1. Contract & Branch</div>
            <div class="grid-3">
                <div><label>Issuing Branch</label>
                    <select id="issuingBranch" onchange="calc()">
                        <option value="HRG">Hurghada Branch</option>
                        <option value="ALX">Alexandria (HQ)</option>
                        <option value="CAI">Cairo Branch</option>
                    </select>
                </div>
                <div><label>Rental Mode</label>
                    <select id="rentalMode" onchange="toggleMode()">
                        <option value="Daily">Daily (Short Term)</option>
                        <option value="Monthly">Monthly (Long Term)</option>
                    </select>
                </div>
                <div><label>Agreement Type</label>
                    <select id="conType" onchange="checkType()">
                        <option value="New">New Agreement</option>
                        <option value="Extension">Extension</option>
                    </select>
                    <input type="text" id="prevCon" placeholder="Prev. Contract No..." style="display:none; margin-top:5px;">
                </div>
            </div>

            <div class="section-head">2. Vehicle Details</div>
            <div class="grid-2">
                <div><label>Select From Fleet</label><select id="carSelect" onchange="loadCar()"><option value="">-- Select Car --</option></select></div>
                <div><label>Manual Model Input</label><input type="text" id="manModel"></div>
            </div>
            <input type="hidden" id="h_plate"><input type="hidden" id="h_color">
            <input type="hidden" id="h_year"><input type="hidden" id="h_vin"><input type="hidden" id="h_motor">

            <div class="grid-4">
                <div><label>KM Out</label><input type="number" id="kmOut" value="0" oninput="calc()"></div>
                <div><label>Fuel Level</label><select id="fuelOut">
                    <option>Full (8/8)</option><option>3/4</option><option>1/2</option><option>1/4</option><option>Reserve</option>
                </select></div>
                <div><label id="lbl_rate">Daily Rent (EGP)</label><input type="number" id="rateRent" value="0" oninput="calc()"></div>
                <div><label>Ins. Fee (Daily)</label><input type="number" id="rateIns" value="0" oninput="calc()"></div>
            </div>

            <div class="section-head">3. Client & Dates</div>
            <div class="grid-4">
                <div><label>Client Name</label><input type="text" id="cl_fname" placeholder="Full Name"></div>
                <div><label>Passport / ID</label><input type="text" id="cl_pass"></div>
                <div><label>Nationality</label><input type="text" id="cl_nation" placeholder="Country"></div>
                <div><label>Phone</label>
                    <div class="phone-group">
                        <input type="text" id="cl_ph_code" value="+20" placeholder="+20">
                        <input type="text" id="cl_phone" placeholder="1XXXXXXXXX">
                    </div>
                </div>
            </div>

            <div class="grid-4">
                <div><label>Email</label><input type="email" id="cl_email"></div>
                <div><label>Driver License</label><input type="text" id="cl_lic" placeholder="License No"></div>
                <div><label>Address</label><input type="text" id="cl_addr" placeholder="Local Address"></div>
                <div><label>Additional Driver</label><input type="text" id="cl_add_driver" placeholder="Name"></div>
            </div>
            <input type="hidden" id="cl_sname"><input type="hidden" id="cl_add_lic">

            <div class="grid-4">
                <div><label>Pickup Date/Time</label><input type="datetime-local" id="p_time" onchange="calc()"></div>
                <div><label>Dropoff Date/Time</label><input type="datetime-local" id="d_time" onchange="calc()"></div>
                <div><label>Pickup Location</label><input type="text" id="p_loc" value="Hotel Azur" oninput="calc()"></div>
                <div><label>Dropoff Location</label><input type="text" id="d_loc" value="Airport Hurghada" oninput="calc()"></div>
            </div>

            <div class="section-head">4. Money & Payments</div>
            <div style="display:flex; gap:15px;">
                <div style="flex:7;">
                    <div class="grid-3">
                        <div><label>Delivery Fee</label><input type="number" id="fee_del" placeholder="Dropoff" oninput="calc()"></div>
                        <div><label>Pickup Fee</label><input type="number" id="fee_col" placeholder="Collection" oninput="calc()"></div>
                        <div><label style="color:var(--accent);">Req. Deposit</label><input type="number" id="req_deposit" placeholder="Amount" oninput="calc()"></div>
                    </div>

                    <div style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:10px; border: 1px solid #e0e0e0;">
                        <div style="font-weight:bold; font-size:11px; margin-bottom:5px; color:var(--primary);">RENT PAID (NOW)</div>
                        <div class="grid-4" style="margin:0;">
                            <div><label>EGP</label><input type="number" id="pay_rent_egp" placeholder="0" oninput="calc()"></div>
                            <div><label>USD</label><input type="number" id="pay_rent_usd" placeholder="0" oninput="calc()"></div>
                            <div><label>EUR</label><input type="number" id="pay_rent_eur" placeholder="0" oninput="calc()"></div>
                            <div><label>Card</label><input type="number" id="pay_rent_card" placeholder="0" oninput="calc()"></div>
                        </div>
                    </div>

                    <div style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:10px; border: 1px solid #e0e0e0;">
                        <div style="font-weight:bold; font-size:11px; margin-bottom:5px; color:var(--accent);">DEPOSIT HELD</div>
                        <div class="grid-4" style="margin:0;">
                            <div><label>EGP</label><input type="number" id="pay_dep_egp" placeholder="0" oninput="calc()"></div>
                            <div><label>USD</label><input type="number" id="pay_dep_usd" placeholder="0" oninput="calc()"></div>
                            <div><label>EUR</label><input type="number" id="pay_dep_eur" placeholder="0" oninput="calc()"></div>
                            <div><label>Card</label><input type="number" id="pay_dep_card" placeholder="0" oninput="calc()"></div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div><label>Insurance Package</label><select id="insPack" onchange="calc()">
                            <option value="Basic">Basic (100% Client Liability)</option>
                            <option value="Intermediate">Intermediate (70% / 30%)</option>
                            <option value="Full Protection">Full Protection (Zero Liability)</option>
                        </select></div>
                        <div><label>Add-ons</label>
                            <div style="font-size:12px; display:flex; gap:10px; margin-top:10px;">
                                <span><input type="checkbox" id="add_km" onchange="calc()" style="width:auto; height:auto;"> Unl. KM</span>
                                <span><input type="checkbox" id="add_dr" onchange="calc()" style="width:auto; height:auto;"> Driver</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="balance-box" style="flex:3;">
                    <div style="border-bottom:1px dashed rgba(255,255,255,0.3); padding-bottom:10px; margin-bottom:10px;">
                        <div style="text-align:center; font-weight:bold; font-size:12px; margin-bottom:10px;">RENT ESTIMATE</div>
                        <div class="bal-row"><span>Base:</span> <strong id="c_rent">0</strong></div>
                        <div class="bal-row"><span>Days:</span> <strong id="c_days">0</strong></div>
                        <div class="bal-row"><span>Fees:</span> <strong id="c_fees">0</strong></div>
                        <div style="text-align:center; font-size:18px; font-weight:bold; color:#e67e22; margin-top:10px;" id="c_total_preview">0 EGP</div>
                    </div>

                    <div style="border-bottom:1px dashed rgba(255,255,255,0.3); padding-bottom:10px; margin-bottom:10px;">
                        <div style="text-align:center; font-weight:bold; font-size:12px; margin-bottom:10px; color:var(--accent);">DEPOSIT</div>
                        <div class="bal-row"><span>Target:</span> <strong id="val_dep_req">0</strong></div>
                        <div class="bal-row"><span>Held:</span> <strong id="val_dep_paid">0</strong></div>
                    </div>

                    <div style="margin-top:auto;">
                        <div class="bal-row"><span>Due:</span> <strong id="val_total_due">0</strong></div>
                        <div class="bal-row"><span>Paid:</span> <strong id="val_total_paid" style="color:var(--success);">0</strong></div>
                        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:6px; text-align:center; margin-top:10px;">
                            <div style="font-size:10px;">PENDING</div>
                            <div id="val_rent_pending" style="font-size:18px; font-weight:bold; color:var(--danger);">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="printContract()" class="btn-print"><i class="fa-solid fa-print"></i> GENERATE CONTRACT PDF</button>
        </div>
    </div>

    <div id="contractOutput"></div>

    <script>
        // 1. DATA
        const fleet = [
            { code: "33", model: "Haval Jolion", year: "2022", plate: "ب ا ن | 2 6 4 9", vin: "606889", motor: "21499022758" },
            { code: "38", model: "Chevrolet Aveo", year: "2020", plate: "ع د ب | 8 2 6 3", vin: "E009927", motor: "191160037" },
            { code: "47", model: "Hyundai Tucson", year: "2022", plate: "ه س ب | 4 2 6 3", vin: "KMHJE81BGN", motor: "G4FPNU539488" },
            { code: "48", model: "Jetour x90 plus", year: "2026", plate: "ف ص ب | 2 9 1 5", vin: "LVTDB21B5TH013984", motor: "SH02227" },
            { code: "34", model: "MG ZS", year: "2025", plate: "ق ه س | 5 3 6 5", vin: "LSJW74U61SZ027362", motor: "3050131" },
            { code: "40", model: "Nissan Sunny", year: "2023", plate: "ل ه ب | 7 3 5 1", vin: "137137", motor: "798285" }
        ];

        const insuranceTexts = {
            Basic: `<strong>BASIC (CDW):</strong> Includes TPL. You pay 100% for damage to car, glass, tires.`,
            Intermediate: `<strong>INTERMEDIATE:</strong> Client pays 70% of repair cost, Company pays 30%. Covers Undercarriage (10k Limit).`,
            "Full Protection": `<strong>FULL PROTECTION:</strong> Zero Excess for Body/Glass. Excludes Interior/Misfueling.`
        };

        // 2. INIT
        window.onload = function () {
            const sel = document.getElementById('carSelect');
            fleet.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c.code;
                opt.text = `[${c.code}] ${c.model} (${c.year}) - ${c.plate}`;
                sel.add(opt);
            });

            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            }, 1000);

            // Fetch Live Rates
            fetch('https://api.exchangerate-api.com/v4/latest/USD')
                .then(r => r.json()).then(d => {
                    if (d.rates.EGP) {
                        document.getElementById('ex_usd').value = d.rates.EGP.toFixed(2);
                        if (d.rates.EUR) document.getElementById('ex_eur').value = (d.rates.EGP / d.rates.EUR).toFixed(2);
                        calc();
                    }
                }).catch(e => { calc(); });

            setTimeout(calc, 500);
        };

        // 3. HELPERS
        function safeVal(id) { var el = document.getElementById(id); return el ? el.value : ""; }
        function safeNum(id) { var el = document.getElementById(id); if (!el || el.value.trim() === "") return 0; return parseFloat(el.value) || 0; }

        function loadCar() {
            const c = fleet.find(x => x.code === safeVal('carSelect'));
            if (c) {
                document.getElementById('manModel').value = c.model;
                document.getElementById('h_plate').value = c.plate;
                document.getElementById('h_year').value = c.year;
                document.getElementById('h_vin').value = c.vin;
                document.getElementById('h_motor').value = c.motor;
                calc();
            }
        }

        function checkType() {
            document.getElementById('prevCon').style.display = (safeVal('conType') === 'Extension') ? 'block' : 'none';
            calc();
        }

        function toggleMode() {
            document.getElementById('lbl_rate').innerText = (safeVal('rentalMode') === 'Monthly') ? "Monthly Rent (EGP)" : "Daily Rent (EGP)";
            calc();
        }

        function calc() {
            const rateUsd = safeNum('ex_usd') || 50;
            const rateEur = safeNum('ex_eur') || 54;
            const pStr = safeVal('p_time');
            const dStr = safeVal('d_time');
            const mode = safeVal('rentalMode');

            let days = 0;
            if (pStr && dStr) {
                const p = new Date(pStr);
                const d = new Date(dStr);
                if (d > p) {
                    days = Math.ceil(Math.abs(d - p) / (1000 * 60 * 60 * 24));
                    if (days < 1) days = 1;
                }
            }
            if (!days || days < 1) days = 1;

            let mult = days;
            if (mode === "Monthly") {
                let m = (days / 30).toFixed(1);
                mult = (m < 1) ? 1 : m;
            }

            const r = safeNum('rateRent');
            const i = safeNum('rateIns');
            const fee_d = safeNum('fee_del');
            const fee_c = safeNum('fee_col');

            let adds = 0; let addOnsList = [];
            if (document.getElementById('add_km').checked) { adds += 500; addOnsList.push(`Unl. KM`); }
            if (document.getElementById('add_dr').checked) { adds += 250; addOnsList.push("Driver"); }
            let addOnsStr = addOnsList.length > 0 ? addOnsList.join(", ") : "None";

            let totalRentOnly = (mode === "Monthly") ? (r * mult) + (i * days) + (adds * days) : ((r + i + adds) * mult);
            let totalDue = totalRentOnly + fee_d + fee_c;

            let totalRentPaid = safeNum('pay_rent_egp') + (safeNum('pay_rent_usd') * rateUsd) + (safeNum('pay_rent_eur') * rateEur) + safeNum('pay_rent_card');
            totalRentPaid = Math.round(totalRentPaid);
            totalDue = Math.round(totalDue);
            let rentPending = totalDue - totalRentPaid;

            let reqDep = safeNum('req_deposit');
            let totalDepPaid = safeNum('pay_dep_egp') + (safeNum('pay_dep_usd') * rateUsd) + (safeNum('pay_dep_eur') * rateEur) + safeNum('pay_dep_card');
            totalDepPaid = Math.round(totalDepPaid);
            let depPending = reqDep - totalDepPaid;

            document.getElementById('c_rent').innerText = Math.round(totalRentOnly).toLocaleString();
            document.getElementById('c_fees').innerText = Math.round(fee_d + fee_c).toLocaleString();
            document.getElementById('c_total_preview').innerText = Math.round(totalDue).toLocaleString() + " EGP";
            document.getElementById('val_total_due').innerText = Math.round(totalDue).toLocaleString();
            document.getElementById('val_total_paid').innerText = Math.round(totalRentPaid).toLocaleString();
            document.getElementById('val_dep_req').innerText = Math.round(reqDep).toLocaleString();
            document.getElementById('val_dep_paid').innerText = Math.round(totalDepPaid).toLocaleString();
            document.getElementById('c_days').innerText = days + " Days";

            let rPenEl = document.getElementById('val_rent_pending');
            if (rentPending > 0) { rPenEl.innerHTML = `<span style="color:#e74c3c">${Math.round(rentPending).toLocaleString()}</span>`; }
            else if (rentPending < 0) { rPenEl.innerHTML = `<span style="color:#2ecc71">+${Math.abs(Math.round(rentPending)).toLocaleString()}</span>`; }
            else { rPenEl.innerHTML = `<span style="color:white">0</span>`; }

            const mData = { days, mult, r, i, adds, fee_d, fee_c, totalDue, mode, totalRentPaid, rentPending, depPending, reqDep, totalRentOnly, addOnsStr };
            render(mData);
            return mData;
        }

        // 4. RENDER HTML
        function render(c) {
            if (!c) return;

            const bMap = { "HRG": "Hurghada", "ALX": "Alexandria", "CAI": "Cairo" };
            const brName = bMap[safeVal('issuingBranch')] || "Branch";
            const cid = `BR-${safeVal('issuingBranch')}-${new Date().getDate().toString().padStart(2, '0')}${(new Date().getMonth() + 1).toString().padStart(2, '0')}-PREVIEW`;
            const today = new Date().toLocaleDateString();

            const usd = safeNum('ex_usd') || 50;
            const eur = safeNum('ex_eur') || 54;

            const buildPayStr = (pfx) => {
                let egp = safeNum(pfx + '_egp'), u = safeNum(pfx + '_usd'), e = safeNum(pfx + '_eur'), card = safeNum(pfx + '_card');
                let total = egp + (u * usd) + (e * eur) + card;
                let parts = [];
                if (egp > 0) parts.push(egp + " Cash"); if (u > 0) parts.push(u + " USD"); if (e > 0) parts.push(e + " EUR"); if (card > 0) parts.push(card + " Card");
                let detail = parts.length > 0 ? `(${parts.join(' + ')})` : "";
                return { total: total, text: `${Math.round(total).toLocaleString()} EGP ${detail}`, breakdownDetails: detail };
            };

            let rentInfo = buildPayStr('pay_rent');
            let depInfo = buildPayStr('pay_dep');

            let rateTxt = c.mode === 'Monthly' ? `${c.r} x ${c.mult} Mo` : `${c.r} x ${c.days} Days`;
            let base = c.mode === 'Monthly' ? (c.r * c.mult) : (c.r * c.days);

            const insKey = safeVal('insPack') || "Basic";
            const simpleInsText = {
                "Basic": "Basic Insurance: 100% Client Liability for Damages.",
                "Intermediate": "Intermediate: 70% Client Liability / 30% Company Coverage.",
                "Full Protection": "Full Protection: Zero Deductible (Subject to caps)."
            };
            const insText = simpleInsText[insKey] || "";
            const insClass = insKey === 'Full Protection' ? 'ins-full' : (insKey === 'Intermediate' ? 'ins-inter' : 'ins-basic');

            // --- PAGE 1: CONTRACT ---
            let html = `
            <div class="a4-page">
                <div class="watermark"><img src="https://brothersegy.com/wp-content/uploads/2026/02/12345.png"></div>
                <div class="page-content">
                    <div class="doc-head">
                        <img src="https://brothersegy.com/wp-content/uploads/2026/02/12345.png" class="logo">
                        <div style="text-align:center">
                            <h1 style="margin:0; font-size:18pt; color:#04509D">CAR RENTAL AGREEMENT</h1>
                            <div style="font-weight:bold; font-size:12pt;">${cid}</div>
                            ${safeVal('conType') === 'Extension' ? '<b>(EXTENSION)</b>' : ''}
                        </div>
                        <div class="hq-info"><strong>BROTHERS EGY HQ</strong><br>Alexandria<br>Tax: 589-464-418<br>Branch: ${brName}</div>
                    </div>

                    <div class="box-section"><span class="bs-title">PARTIES</span>
                        <table class="pt">
                            <tr><td width="30%"><strong>LESSOR</strong><br>El Alakhua El Mutahidun<br>${safeVal('issuingBranch')} Branch</td>
                                <td><strong>LESSEE</strong><br>Name: ${safeVal('cl_fname')} ${safeVal('cl_sname')}<br>
                                Passport: ${safeVal('cl_pass')} | Lic: ${safeVal('cl_lic')} | Nat: ${safeVal('cl_nation')}<br>
                                Phone: ${safeVal('cl_ph_code')} ${safeVal('cl_phone')} | Addr: ${safeVal('cl_addr')}</td></tr>
                        </table>
                    </div>

                    <div class="box-section"><span class="bs-title">VEHICLE & PERIOD</span>
                        <table class="pt">
                            <tr><th>Model</th><td>${safeVal('manModel')}</td><th>Plate</th><td><b>${safeVal('h_plate')}</b></td><th>KM Out</th><td>${safeVal('kmOut')}</td></tr>
                            <tr><th>VIN</th><td>${safeVal('h_vin')}</td><th>Motor</th><td>${safeVal('h_motor')}</td><th>Allow</th><td>${document.getElementById('add_km').checked ? "Unlimited" : (120 * c.days) + " KM"}</td></tr>
                            <tr><th>Pickup</th><td>${safeVal('p_time').replace('T', ' ')}<br>${safeVal('p_loc')}</td>
                                <th>Dropoff</th><td>${safeVal('d_time').replace('T', ' ')}<br>${safeVal('d_loc')}</td></tr>
                        </table>
                    </div>

                    <div class="box-section"><span class="bs-title">FINANCIAL BREAKDOWN</span>
                        <table class="pt">
                            <tr><th>Item Description</th><th>Calculation</th><th style="text-align:right">Amount (EGP)</th></tr>
                            <tr><td>Base Rent</td><td>${rateTxt}</td><td align="right">${Math.round(base).toLocaleString()}</td></tr>
                            ${c.i > 0 ? `<tr><td>Insurance Fees</td><td>${c.i} x ${c.days} Days</td><td align="right">${(c.i * c.days).toLocaleString()}</td></tr>` : ''}
                            ${c.adds > 0 ? `<tr><td>Add-ons</td><td>${c.adds} x ${c.days} Days</td><td align="right">${(c.adds * c.days).toLocaleString()}</td></tr>` : ''}
                            ${c.fee_d > 0 ? `<tr><td>Delivery Fee</td><td>Fixed</td><td align="right">${c.fee_d}</td></tr>` : ''}
                            ${c.fee_c > 0 ? `<tr><td>Pickup Fee</td><td>Fixed</td><td align="right">${c.fee_c}</td></tr>` : ''}
                            <tr style="font-weight:bold; border-top:2px solid #000;"><td colspan="2" align="right">TOTAL CONTRACT VALUE:</td><td align="right">${Math.round(c.totalDue).toLocaleString()} EGP</td></tr>
                        </table>
                        <div class="${insClass}" style="border:1px solid #000; padding:5px; text-align:center; font-size:9pt; margin-bottom:5px;">${insText}</div>
                        <div style="background:#eee; padding:5px; text-align:center;">
                            PAID NOW: ${rentInfo.text} <br> <span style="color:${c.rentPending > 0 ? '#c0392b' : '#27ae60'}; font-weight:bold;">PENDING: ${Math.round(c.rentPending).toLocaleString()} EGP</span>
                        </div>
                    </div>

                    ${(c.reqDep > 0) ? `<div style="border:2px solid orange; padding:5px; font-size:9pt;"><strong>DEPOSIT HELD:</strong> ${depInfo.text} <span style="float:right; font-weight:bold; color:${c.depPending > 0 ? '#c0392b' : '#27ae60'}">${c.depPending > 0 ? Math.round(c.depPending) + ' EGP PENDING' : 'FULLY HELD'}</span></div>` : ''}

                    <div style="text-align:center; border:2px dashed #000; padding:10px; font-size:9pt; margin-top:10px;">
                        <strong>IMPORTANT:</strong> Contract is void for any period NOT covered by an official payment receipt.<br>
                        <strong>LIABILITY:</strong> Lessee retains full liability until RETURN CHECK is officially closed.
                    </div>

                    <div style="margin-top:auto; border-top:2px solid #000; padding-top:10px; display:flex; justify-content:space-between; text-align:center; font-weight:bold;">
                        <div style="width:40%;">LESSOR SIGNATURE<br><br><br>____________________</div>
                        <div style="width:40%;">LESSEE SIGNATURE<br><br><br>____________________</div>
                    </div>
                </div>
            </div>`;

            // --- PAGE 2: TERMS ---
            const termDetail = {
                "Basic": `<strong>High Deductible.</strong> You pay 100% for Glass, Tires, and Undercarriage damages.<br><strong>INCLUDES:</strong> Standard CDW (Body damage only with excess).<br><strong>EXCLUDES:</strong> All glass, tires, undercarriage, towing, third party.`,
                "Intermediate": `<strong>Reduced Liability.</strong> Client pays 70% of repair costs. Company pays 30%.<br><strong>INCLUDES:</strong> Undercarriage coverage up to 10K EGP.<br><strong>EXCLUDES:</strong> Glass, Tires, and Interior damage.`,
                "Full Protection": `<strong>Zero Deductible.</strong> Reduces liability to ZERO for covered items.<br><strong>CAPS:</strong> Roof (20k), Glass (25k), Undercarriage (40k), Tires (4k/tire).<br><strong>EXCLUDES:</strong> Interior damage (saloon), misfueling, keys.`
            };

            html += `
            <div class="a4-page">
                <div class="watermark"><img src="https://brothersegy.com/wp-content/uploads/2026/02/12345.png"></div>
                <div class="page-content">
                    <div class="doc-head"><strong>TERMS & CONDITIONS</strong><span>Page 2/4</span></div>
                    <div class="terms-grid">
                        <div class="term-p"><span class="term-h">1. DRIVER REQUIREMENTS</span> Min 21 years old. Valid ID and License required.</div>
                        <div class="term-p"><span class="term-h">2. RENTAL PERIOD</span> 24-Hour Cycle. 1-hour grace period. Late = Full day charge.</div>
                        <div class="term-p"><span class="term-h">3. CANCELLATION</span> >48h = Full refund. <48h = 30% Deducted. No Show = No Refund.</div>
                        
                        <div class="term-box" style="border:2px solid #e67e22; background:#fff8e1; color:#000;">
                            <span class="term-h" style="border-bottom:1px solid #e67e22; color:#e67e22;">YOUR INSURANCE: ${insKey.toUpperCase()}</span>
                            <div style="font-weight:normal; font-size:8pt; margin-top:5px;">${termDetail[insKey]}</div>
                        </div>

                        <div class="term-p"><span class="term-h">4. THEFT</span> Theft is <strong>NOT covered</strong>. Lessee is 100% responsible.</div>
                        <div class="term-p"><span class="term-h">5. POLICE REPORT</span> Mandatory for ANY accident. No report = Full Liability.</div>
                        <div class="term-p"><span class="term-h">6. PENALTIES</span> Key: 20k, License: 12.5k, Tire: 10k, Interior: 5k - 50k EGP.</div>
                        <div class="term-p"><span class="term-h">7. TRAFFIC FINES</span> Lessee pays 100% of all traffic and parking fines.</div>
                        <div class="term-p"><span class="term-h">8. DISPUTES</span> Resolved by Independent Car Service Center. Quote is binding.</div>
                    </div>
                    <div style="margin-top:auto; padding:15px; border-top:1px solid #000; font-weight:bold; text-align:center;">
                        I have read and accepted all terms & conditions.<br><br>Signature: __________________________
                    </div>
                </div>
            </div>`;

            // --- PAGE 3: INSPECTION ---
            const chk = `<div class="v-insp-row"><span class="v-label">FEND F</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>
                         <div class="v-insp-row"><span class="v-label">DOOR F</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>
                         <div class="v-insp-row"><span class="v-label">DOOR R</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>
                         <div class="v-insp-row"><span class="v-label">FEND R</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>`;
            
            const chkF = `<div class="v-insp-row"><span class="v-label">BUMPER</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>
                          <div class="v-insp-row"><span class="v-label">HOOD</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>
                          <div class="v-insp-row"><span class="v-label">WINDSH</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>`;
            
            const chkR = `<div class="v-insp-row"><span class="v-label">TRUNK</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>
                          <div class="v-insp-row"><span class="v-label">BUMPER</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>
                          <div class="v-insp-row"><span class="v-label">LIGHTS</span><div class="v-check-box v-green"></div><div class="v-check-box v-red"></div></div>`;

            const block = `
                <div class="car-img-container"><img src="https://brothersegy.com/wp-content/uploads/2026/02/car-template.png"></div>
                <div class="tire-img-wrapper"><div class="tire-img-container"><img src="https://brothersegy.com/wp-content/uploads/2026/02/wheel-tyre-illustration-png.png"></div><div style="font-size:7pt;"><strong>TIRE:</strong> _________________</div></div>
                <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                    <div style="width:48%;"><div class="insp-group-head">PASSENGER</div>${chk}</div>
                    <div style="width:48%;"><div class="insp-group-head">FRONT</div>${chkF}</div>
                    <div style="width:48%;"><div class="insp-group-head">REAR</div>${chkR}</div>
                    <div style="width:48%;"><div class="insp-group-head">DRIVER</div>${chk}</div>
                </div>`;

            html += `
            <div class="a4-page">
                <div class="watermark"><img src="https://brothersegy.com/wp-content/uploads/2026/02/12345.png"></div>
                <div class="page-content">
                    <div class="doc-head"><strong>VISUAL INSPECTION REPORT</strong><span>Page 3/4</span></div>
                    
                    <div class="insp-two-col">
                        <div class="insp-left-col">
                            <div class="insp-section-head">PICKUP CHECK (Start of Rental)</div>
                            <div style="font-size:7pt; text-align:center;"><strong>KM OUT:</strong> ${safeVal('kmOut')} | <strong>FUEL:</strong> ${safeVal('fuelOut')}</div>
                            ${block}
                        </div>
                        <div class="insp-right-col">
                            <div class="insp-section-head">RETURN CHECK (End of Rental)</div>
                            <div style="font-size:7pt; text-align:center;"><strong>KM IN:</strong> __________ | <strong>FUEL:</strong> __________</div>
                            ${block}
                            <div class="box-section" style="margin-top:5px; padding:2px;"><span class="bs-title" style="font-size:7pt;">FINAL SETTLEMENT</span>
                                <table class="pt" style="font-size:8pt;">
                                    <tr><th width="70%">Item Description</th><th>Cost (EGP)</th></tr> 
                                    <tr><td>Excess KM / Late Return</td><td align="right">_______</td></tr>
                                    <tr><td>New Damages / Fines</td><td align="right">_______</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:auto; border-top:2px solid #000; padding-top:10px; display:flex; justify-content:space-between; text-align:center; font-weight:bold;">
                        <div style="width:30%;">PICKUP SIGNATURE<br><br><br>____________________</div>
                        <div style="width:30%;">RETURN SIGNATURE<br><br><br>____________________</div>
                        <div style="width:30%;">EMPLOYEE CHECK<br><br><br>____________________</div>
                    </div>
                </div>
            </div>`;

            // --- PAGE 4: RECEIPTS (EXACT ALIGNMENT FIX) ---
            const recData = {
                client: `${safeVal('cl_fname')} ${safeVal('cl_sname')}`, lic: safeVal('cl_lic'),
                phone: `${safeVal('cl_ph_code')} ${safeVal('cl_phone')}`, con: cid,
                car: `${safeVal('manModel')} | Plate: ${safeVal('h_plate')} | (${safeVal('h_year')})`,
                period: `${safeVal('p_time').replace('T', ' ')} to ${safeVal('d_time').replace('T', ' ')}`
            };

            const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?data=https://brothersegy.com&size=80x80";

            const singleRecHtml = (title, copyType, amount, details, isBlank = false) => `
                <div class="receipt-half">
                    <div class="rec-header">
                        <img src="https://brothersegy.com/wp-content/uploads/2026/02/12345.png" class="rec-logo">
                        <div style="text-align:center; flex-grow:1;">
                            <div class="rec-title">OFFICIAL RECEIPT</div>
                            <div style="font-size:9pt; color:#555; text-transform:uppercase;">${copyType}</div>
                        </div>
                        <img src="${qrUrl}" class="rec-logo" style="margin-right:15px;">
                        <div style="text-align:right; font-size:9pt; line-height:1.2;">
                            <div>DATE: ${isBlank ? "___/___/___" : today}</div>
                            <div style="font-weight:bold; font-size:10pt;">${title}</div>
                        </div>
                    </div>

                    <div class="rec-body-grid">
                        <div class="rec-col">
                            <div class="rec-row"><span class="rec-label">RECEIVED FROM</span><span class="rec-val">${recData.client}</span></div>
                            <div class="rec-row"><span class="rec-label">LICENSE NO</span><span class="rec-val">${recData.lic || '-'}</span></div>
                            <div class="rec-row"><span class="rec-label">PHONE</span><span class="rec-val">${recData.phone}</span></div>
                        </div>
                        <div class="rec-col">
                            <div class="rec-row"><span class="rec-label">CONTRACT NO</span><span class="rec-val">${recData.con}</span></div>
                            <div class="rec-row"><span class="rec-label">VEHICLE</span><span class="rec-val">${recData.car}</span></div>
                            <div class="rec-row"><span class="rec-label">PERIOD</span><span class="rec-val">${recData.period}<br>(${c.days} Days)</span></div>
                        </div>
                    </div>

                    <div class="rec-amount-box">
                        <div class="rec-amount-row">
                            <span class="rec-amount-lbl">AMOUNT RECEIVED</span>
                            <span class="rec-amount-val">${isBlank ? "____________ EGP" : Math.round(amount).toLocaleString() + " EGP"}</span>
                        </div>
                        <div class="rec-amount-row" style="margin-bottom:0;">
                            <span class="rec-amount-lbl" style="font-size:8pt;">PAYMENT DETAILS</span>
                            <span class="rec-val" style="font-size:9pt;">${isBlank ? "________________________" : details}</span>
                        </div>
                    </div>
                    
                    <div style="font-size:7pt; color:#666; margin-top:5px;">
                        ${!title.includes("DEPOSIT") ? "<strong>Breakdown:</strong> Base Tariff + Added Services (Insurance, Delivery, Logistics).<br>" : "<strong style='color:#c0392b;'>* Fully refundable if returned in same condition. Deductions apply for damages/fines.</strong><br>"}
                        ${!title.includes("DEPOSIT") && c.rentPending > 0 ? `<span style="color:#c0392b; font-weight:bold;">⚠ OUTSTANDING BALANCE: ${Math.round(c.rentPending).toLocaleString()} EGP</span>` : ''}
                    </div>
                </div>`;

            html += `
            <div class="a4-page">
                <div class="page-content">
                    ${singleRecHtml('RENTAL PAYMENT', 'CLIENT COPY', c.totalRentPaid, rentInfo.breakdownDetails)}
                    <div style="text-align:center; border-top:1px dashed #999; color:#999; padding: 10px 0;">- - - - - DETACH HERE - - - - -</div>
                    ${singleRecHtml('RENTAL PAYMENT', 'COMPANY COPY', c.totalRentPaid, rentInfo.breakdownDetails)}
                </div>
            </div>`;

            if (c.reqDep > 0 || totalDepPaid > 0) {
                html += `
                <div class="a4-page">
                    <div class="page-content">
                        ${singleRecHtml('SECURITY DEPOSIT', 'CLIENT COPY', (totalDepPaid > 0 ? totalDepPaid : c.reqDep), depInfo.breakdownDetails || "Pending")}
                        <div style="text-align:center; border-top:1px dashed #999; color:#999; padding: 10px 0;">- - - - - DETACH HERE - - - - -</div>
                        ${singleRecHtml('SECURITY DEPOSIT', 'COMPANY COPY', (totalDepPaid > 0 ? totalDepPaid : c.reqDep), depInfo.breakdownDetails || "Pending")}
                    </div>
                </div>`;
            }

            document.getElementById('contractOutput').innerHTML = html;
        }

        // 5. PRINT (Generate final ID on print)
        function printContract() {
            const bMap = { "HRG": "HRG", "ALX": "ALX", "CAI": "CAI" };
            const bCode = bMap[safeVal('issuingBranch')] || "GEN";
            const dStr = new Date().getDate().toString().padStart(2, '0') + (new Date().getMonth() + 1).toString().padStart(2, '0');
            const realId = `BR-${bCode}-${dStr}-${Math.floor(1000 + Math.random() * 9000)}`;
            
            // Quickly swap PREVIEW string with Real ID before print
            document.getElementById('contractOutput').innerHTML = document.getElementById('contractOutput').innerHTML.replace(/-PREVIEW/g, `-${Math.floor(1000 + Math.random() * 9000)}`);
            
            window.print();
            
            // Re-render preview to get 'PREVIEW' back on screen
            setTimeout(calc, 1000); 
        }
    </script>
</body>
</html>
