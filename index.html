<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brothers EGY - Contract System v82.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ================= SCREEN UI ================= */
        :root {
            --primary: #04509D;
            --secondary: #333;
            --bg: #eef2f5;
            --accent: #e67e22;
            --success: #27ae60;
            --danger: #c0392b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 10px 20px;
            color: #333;
        }

        /* FLOATING PILL HEADER */
        .floating-header {
            max-width: 1050px;
            margin: 10px auto 20px auto;
            background: white;
            border: 3px solid var(--primary);
            border-radius: 50px;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .rate-group { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
        .badge-live { background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: bold; text-transform: uppercase; }
        .live-clock { font-family: monospace; font-weight: bold; font-size: 13px; color: var(--primary); }
        .rate-input { width: 70px !important; font-weight: bold; color: #000; text-align: center; border: 1px solid #ccc !important; height: 26px !important; border-radius: 4px; font-size: 12px !important; }

        /* MAIN CONTROL PANEL */
        .control-panel { max-width: 1050px; margin: 0 auto 40px auto; background: transparent; }
        .cp-body { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08); }

        .section-head { font-size: 14px; font-weight: 800; color: var(--secondary); text-transform: uppercase; margin: 25px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #eee; }
        .section-head:first-child { margin-top: 0; }

        label { display: block; font-size: 10px; font-weight: 700; color: #555; margin-bottom: 4px; text-transform: uppercase; }
        input, select { width: 100%; box-sizing: border-box; padding: 0 12px; height: 40px; font-size: 13px; border: 1px solid #ccc; border-radius: 5px; transition: 0.2s; }
        select { cursor: pointer; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(4, 80, 157, 0.1); }

        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 12px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 12px; }

        .phone-group { display: flex; gap: 5px; }
        .phone-group input:first-child { width: 70px; text-align: center; flex-shrink: 0; }
        .phone-group input:last-child { flex: 1; }

        /* MONEY & BALANCES */
        .balance-box {
            background: #2c3e50; color: white; padding: 20px; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%; box-sizing: border-box; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        .bal-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 3px; }

        .btn-gen {
            background: var(--primary); color: white; border: none; padding: 18px; width: 100%;
            font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 25px;
            display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.3s; text-transform: uppercase;
        }
        .btn-gen:hover { background: #033a75; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }
        .btn-gen:disabled { background: #95a5a6; cursor: wait; transform: none; box-shadow: none; }

        .btn-final-print {
            background: var(--success); color: white; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; text-transform: uppercase; margin: 0 auto 20px auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); width:100%; max-width: 1050px;
        }
        .btn-final-print:hover { background: #219653; transform: scale(1.01); }

        .ins-basic { background-color: #ffebee !important; border: 2px solid #c0392b !important; color: #c0392b !important; }
        .ins-inter { background-color: #fff3e0 !important; border: 2px solid #e67e22 !important; color: #e67e22 !important; }
        .ins-full { background-color: #e8f5e9 !important; border: 2px solid #27ae60 !important; color: #27ae60 !important; }

        /* ================= A4 PAGE PREVIEW & PRINT STYLES ================= */
        #contractOutput { display: none; margin-top: 20px; }

        .a4-page {
            width: 210mm; height: 296mm; padding: 10mm 15mm; margin: 0 auto 30px auto;
            background: white; position: relative; box-sizing: border-box; overflow: hidden;
            font-family: 'Helvetica', 'Arial', sans-serif; font-size: 9.5pt; line-height: 1.35; color: #000;
            display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0, 0, 0, 0.15); page-break-after: always;
        }

        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 75%; opacity: 0.05; z-index: 0; pointer-events: none; }
        .watermark img { width: 100%; height: auto; }
        .page-content { position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between; }

        /* Document Headers */
        .doc-head { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 12px; }
        .logo { width: 180px; height: auto; object-fit: contain; }
        .hq-info { font-size: 8pt; color: #555; line-height: 1.4; text-align: right; }

        .box-section { border: 1px solid #000; padding: 8px; margin-bottom: 12px; position: relative; }
        .bs-title { background: #000; color: white; padding: 2px 8px; font-weight: bold; font-size: 8pt; position: absolute; top: -10px; left: -1px; text-transform: uppercase; }
        
        .pt { width: 100%; border-collapse: collapse; font-size: 9pt; margin-bottom: 5px; }
        .pt th, .pt td { border: 1px solid #000; padding: 4px; text-align: left; vertical-align: middle; }
        .pt th { background: #f0f0f0; text-align: center; font-weight: bold; }

        /* Terms */
        .terms-grid { font-size: 9pt; text-align: justify; column-count: 2; column-gap: 30px; line-height: 1.3; flex-grow: 1; }
        .term-p { margin-bottom: 12px; break-inside: avoid; }
        .term-h { font-weight: 800; text-transform: uppercase; display: block; margin-bottom: 3px; border-bottom: 1px solid #999; padding-bottom: 2px; font-size: 9.5pt; color: var(--primary); }

        /* Inspection */
        .car-img-container { width: 100%; aspect-ratio: 960/618; display: flex; align-items: center; justify-content: center; margin-bottom: 2px; }
        .car-img-container img { width: 100%; height: 100%; object-fit: contain; }
        .tire-img-wrapper { display: flex; align-items: center; gap: 5px; justify-content: center; margin-top: 2px; }
        .tire-img-container { height: 50px; aspect-ratio: 219/350; display: flex; align-items: center; justify-content: center; }
        .tire-img-container img { width: 100%; height: 100%; object-fit: contain; }

        .insp-two-col { display: flex; width: 100%; height: 100%; gap: 10px; }
        .insp-left-col { width: 50%; border-right: 1px dashed #000; padding-right: 10px; display: flex; flex-direction: column; justify-content: flex-start; }
        .insp-right-col { width: 50%; padding-left: 10px; display: flex; flex-direction: column; justify-content: flex-start; }
        
        .insp-section-head { background: #eee; font-weight: bold; padding: 5px; text-align: center; font-size: 9pt; border-bottom: 1px solid #000; margin-bottom: 5px; text-transform: uppercase; }
        .insp-group-head { background: #000; color: #fff; font-weight: bold; font-size: 7.5pt; padding: 2px 4px; margin-top: 5px; margin-bottom: 3px; text-transform: uppercase; border-radius: 2px; }
        
        .v-insp-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 3px; font-size: 7pt; border-bottom: 1px dotted #ccc; padding-bottom: 2px; }
        .v-label { font-weight: bold; font-size: 6.5pt; text-transform: uppercase; flex-grow: 1; }
        .v-check-group { display: flex; gap: 3px; }
        .v-check-box { width: 12px; height: 12px; border: 1.5px solid #000; display: inline-block; background: transparent; }
        .v-green { border-color: #27ae60; background: #e8f8f5; }
        .v-red { border-color: #c0392b; background: #fdedec; }

        /* Receipts */
        .receipt-half { height: 48%; border: 2px solid #000; padding: 15px; display: flex; flex-direction: column; position: relative; box-sizing: border-box; background: white; margin-bottom: 0; }
        .rec-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
        .rec-logo { height: 45px; }
        .rec-title { font-size: 16pt; font-weight: bold; text-transform: uppercase; color: var(--primary); }
        .rec-body-grid { display: flex; gap: 20px; font-size: 9pt; line-height: 1.6; border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .rec-col { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .rec-row { display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; }
        .rec-label { font-weight: bold; color: #555; text-transform: uppercase; font-size: 8.5pt; }
        .rec-val { font-weight: bold; color: #000; text-align: right; }
        .rec-amount-box { border: 1px solid #ccc; background: #fbfbfb; padding: 10px 15px; margin-bottom: 5px; }
        .rec-amount-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .rec-amount-lbl { font-weight: bold; color: #555; font-size: 10pt; text-transform: uppercase; }
        .rec-amount-val { font-size: 18pt; font-weight: bold; color: #000; }
        .rec-sig-line { border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 5px; font-size: 9pt; font-weight: bold; }

        /* STRICT PRINT PAGE ENFORCEMENT */
        @media print {
            body { background: white; padding: 0; margin: 0; visibility: hidden; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            @page { margin: 0; size: A4; }
            .floating-header, .control-panel, .btn-print, .btn-final-print { display: none !important; }
            
            #contractOutput { visibility: visible; display: block !important; position: absolute; left: 0; top: 0; width: 100%; margin: 0; }
            #contractOutput * { visibility: visible; }
            
            .a4-page { box-shadow: none !important; margin: 0 !important; border: none !important; page-break-after: always; page-break-inside: avoid; height: 297mm; width: 210mm; overflow: hidden; }
            .a4-page:last-child { page-break-after: avoid; }
        }
    </style>
</head>

<body>

    <div class="floating-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <img src="https://brothersegy.com/wp-content/uploads/2026/02/12345.png" style="height:40px;" alt="Logo">
            <h2 style="margin:0; color:var(--primary); font-size:18px;">Smart Contract v82.0</h2>
        </div>
        <div style="display:flex; gap:20px; align-items:center;">
            <div class="rate-group">
                <i class="fa-regular fa-clock" style="color:var(--primary);"></i>
                <div id="clock" class="live-clock">--:--:--</div>
            </div>
            <div class="rate-group">
                <div style="font-size:10px; font-weight:bold; color:#555;">USD <span class="badge-live">LIVE</span></div>
                <input type="number" id="ex_usd" class="rate-input" value="50.00" oninput="calc()">
            </div>
            <div class="rate-group">
                <div style="font-size:10px; font-weight:bold; color:#555;">EUR <span class="badge-live">LIVE</span></div>
                <input type="number" id="ex_eur" class="rate-input" value="54.00" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div class="cp-body">

            <div class="section-head">1. Contract & Branch</div>
            <div class="grid-3">
                <div><label>Issuing Branch</label>
                    <select id="issuingBranch" onchange="calc()">
                        <option value="HRG">Hurghada Branch</option>
                        <option value="ALX">Alexandria (HQ)</option>
                        <option value="CAI">Cairo Branch</option>
                        <option value="RSD">Rashid Branch</option>
                    </select>
                </div>
                <div><label>Rental Mode</label>
                    <select id="rentalMode" onchange="toggleMode()">
                        <option value="Daily">Daily (Short Term)</option>
                        <option value="Monthly">Monthly (Long Term)</option>
                    </select>
                </div>
                <div><label>Agreement Type</label>
                    <select id="conType" onchange="checkType()">
                        <option value="New">New Agreement</option>
                        <option value="Extension">Extension</option>
                    </select>
                    <input type="text" id="prevCon" placeholder="Prev. Contract No..." style="display:none; margin-top:5px; border-color:var(--accent);" oninput="calc()">
                </div>
            </div>

            <div class="section-head">2. Vehicle Details</div>
            <div class="grid-2">
                <div><label>Select From Fleet</label><select id="carSelect" onchange="loadCar()"><option value="">-- Select Car --</option></select></div>
                <div><label>Manual Model Input</label><input type="text" id="manModel"></div>
            </div>
            <input type="hidden" id="h_plate"><input type="hidden" id="h_color"><input type="hidden" id="h_year"><input type="hidden" id="h_vin"><input type="hidden" id="h_motor">

            <div class="grid-4">
                <div><label>KM Out</label><input type="number" id="kmOut" value="0" oninput="calc()"></div>
                <div><label>Fuel Level</label><select id="fuelOut">
                    <option>Full (8/8)</option><option>3/4</option><option>1/2</option><option>1/4</option><option>Reserve</option>
                </select></div>
                <div><label id="lbl_rate">Daily Rent (EGP)</label><input type="number" id="rateRent" value="0" oninput="calc()"></div>
                <div><label>Ins. Fee (Daily)</label><input type="number" id="rateIns" value="0" oninput="calc()"></div>
            </div>

            <div class="section-head">3. Client & Dates</div>
            <div class="grid-4">
                <div><label>First Name</label><input type="text" id="cl_fname" placeholder="First"></div>
                <div><label>Surname</label><input type="text" id="cl_sname" placeholder="Last"></div>
                <div><label>Passport / ID</label><input type="text" id="cl_pass"></div>
                <div><label>Nationality</label><input type="text" id="cl_nation" placeholder="Country"></div>
            </div>
            <div class="grid-4">
                <div><label>Phone</label>
                    <div class="phone-group">
                        <input type="text" id="cl_ph_code" value="+20" placeholder="+20">
                        <input type="text" id="cl_phone" placeholder="1XXXXXXXXX">
                    </div>
                </div>
                <div><label>Driver License</label><input type="text" id="cl_lic" placeholder="Main License"></div>
                <div><label>Address</label><input type="text" id="cl_addr" placeholder="Local Address"></div>
                <div><label>Additional Driver</label><input type="text" id="cl_add_driver" placeholder="Name"></div>
            </div>
            <input type="hidden" id="cl_add_lic">

            <div class="grid-4" style="margin-top:10px;">
                <div><label>Pickup Date/Time</label><input type="datetime-local" id="p_time" onchange="calc()"></div>
                <div><label>Pickup Location</label>
                    <select id="p_loc" onchange="calc()">
                        <option value="Office">Office</option>
                        <option value="Airport">Airport</option>
                        <option value="Hotel">Hotel</option>
                    </select>
                    <input type="text" id="p_addr" placeholder="Specific Addr..." style="margin-top:5px;" oninput="calc()">
                </div>
                <div><label>Dropoff Date/Time</label><input type="datetime-local" id="d_time" onchange="calc()"></div>
                <div><label>Dropoff Location</label>
                    <select id="d_loc" onchange="calc()">
                        <option value="Office">Office</option>
                        <option value="Airport">Airport</option>
                        <option value="Hotel">Hotel</option>
                    </select>
                    <input type="text" id="d_addr" placeholder="Specific Addr..." style="margin-top:5px;" oninput="calc()">
                </div>
            </div>

            <div class="section-head">4. Money & Payments</div>
            <div style="display:flex; gap:15px;">
                <div style="flex:7;">
                    <div class="grid-3">
                        <div><label>Delivery Fee</label><input type="number" id="fee_del" placeholder="Dropoff" oninput="calc()"></div>
                        <div><label>Pickup Fee</label><input type="number" id="fee_col" placeholder="Collection" oninput="calc()"></div>
                        <div><label style="color:var(--accent);">Req. Deposit</label><input type="number" id="req_deposit" placeholder="Amount" value="0" oninput="calc()"></div>
                    </div>

                    <div style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:10px; border: 1px solid #e0e0e0;">
                        <div style="font-weight:bold; font-size:11px; margin-bottom:5px; color:var(--primary);">RENT PAID (NOW)</div>
                        <div class="grid-4" style="margin:0;">
                            <div><label>EGP</label><input type="number" id="pay_rent_egp" placeholder="0" oninput="calc()"></div>
                            <div><label>USD</label><input type="number" id="pay_rent_usd" placeholder="0" oninput="calc()"></div>
                            <div><label>EUR</label><input type="number" id="pay_rent_eur" placeholder="0" oninput="calc()"></div>
                            <div><label>Card (EGP)</label><input type="number" id="pay_rent_card" placeholder="0" oninput="calc()"></div>
                        </div>
                    </div>

                    <div style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:10px; border: 1px solid #e0e0e0;">
                        <div style="font-weight:bold; font-size:11px; margin-bottom:5px; color:var(--accent);">DEPOSIT HELD</div>
                        <div class="grid-4" style="margin:0;">
                            <div><label>EGP</label><input type="number" id="pay_dep_egp" placeholder="0" oninput="calc()"></div>
                            <div><label>USD</label><input type="number" id="pay_dep_usd" placeholder="0" oninput="calc()"></div>
                            <div><label>EUR</label><input type="number" id="pay_dep_eur" placeholder="0" oninput="calc()"></div>
                            <div><label>Card (EGP)</label><input type="number" id="pay_dep_card" placeholder="0" oninput="calc()"></div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div><label>Insurance Package</label><select id="insPack" onchange="calc()">
                            <option value="Basic">Basic (100% Client Liability)</option>
                            <option value="Intermediate">Intermediate (70% / 30%)</option>
                            <option value="Full Protection">Full Protection (Zero Liability)</option>
                        </select></div>
                        
                        <div><label>Add-ons (Toggle & Set Rate/Day)</label>
                            <div style="display:flex; flex-direction:column; gap:5px; margin-top:5px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <input type="checkbox" id="add_km" onchange="calc()" style="width:15px; height:15px; margin:0;">
                                    <span style="font-size:12px; width:65px;">Unl. KM</span>
                                    <input type="number" id="rate_km" value="500" oninput="calc()" style="height:26px; padding:2px 8px;">
                                </div>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <input type="checkbox" id="add_dr" onchange="calc()" style="width:15px; height:15px; margin:0;">
                                    <span style="font-size:12px; width:65px;">Driver</span>
                                    <input type="number" id="rate_dr" value="250" oninput="calc()" style="height:26px; padding:2px 8px;">
                                </div>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <input type="checkbox" id="add_st" onchange="calc()" style="width:15px; height:15px; margin:0;">
                                    <span style="font-size:12px; width:65px;">Child Seat</span>
                                    <input type="number" id="rate_st" value="250" oninput="calc()" style="height:26px; padding:2px 8px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="balance-box" style="flex:3;">
                    <div style="border-bottom:1px dashed rgba(255,255,255,0.3); padding-bottom:10px; margin-bottom:10px;">
                        <div style="text-align:center; font-weight:bold; font-size:12px; margin-bottom:10px;">RENT ESTIMATE</div>
                        <div class="bal-row"><span>Base:</span> <strong id="c_rent">0</strong></div>
                        <div class="bal-row"><span>Days:</span> <strong id="c_days">0</strong></div>
                        <div class="bal-row"><span>Fees/Addons:</span> <strong id="c_fees">0</strong></div>
                        <div style="text-align:center; font-size:18px; font-weight:bold; color:#e67e22; margin-top:10px;" id="c_total_preview">0 EGP</div>
                    </div>

                    <div style="border-bottom:1px dashed rgba(255,255,255,0.3); padding-bottom:10px; margin-bottom:10px;">
                        <div style="text-align:center; font-weight:bold; font-size:12px; margin-bottom:10px; color:var(--accent);">DEPOSIT</div>
                        <div class="bal-row"><span>Target:</span> <strong id="val_dep_req">0</strong></div>
                        <div class="bal-row"><span>Held:</span> <strong id="val_dep_paid">0</strong></div>
                        <div style="background:rgba(0,0,0,0.2); padding:5px; border-radius:4px; text-align:center; margin-top:5px;">
                            <div style="font-size:9px;">DEPOSIT STATUS</div>
                            <div id="val_dep_pending" style="font-size:13px; font-weight:bold;">0</div>
                        </div>
                    </div>

                    <div style="margin-top:auto;">
                        <div class="bal-row"><span>Due:</span> <strong id="val_total_due">0</strong></div>
                        <div class="bal-row"><span>Paid:</span> <strong id="val_total_paid" style="color:var(--success);">0</strong></div>
                        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:6px; text-align:center; margin-top:10px;">
                            <div style="font-size:10px;">RENT PENDING</div>
                            <div id="val_rent_pending" style="font-size:18px; font-weight:bold; color:var(--danger);">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="btnGen" class="btn-gen" onclick="generatePreview()"><i class="fa-solid fa-file-contract"></i> 1. GENERATE PREVIEW</button>
        </div>
    </div>

    <button id="btnRealPrint" onclick="printContract()" class="btn-final-print"><i class="fa-solid fa-print"></i> 2. PRINT / SAVE PDF</button>
    <div id="contractOutput"></div>

    <div style="display:none;">
        <img id="img_logo" src="https://brothersegy.com/wp-content/uploads/2025/07/22wdd.jpg" crossorigin="anonymous">
        <img id="img_water" src="https://brothersegy.com/wp-content/uploads/2026/02/12345.png" crossorigin="anonymous">
        <img id="img_car" src="https://brothersegy.com/wp-content/uploads/2026/02/تصميم-هيكل-السيارة-للعقود.jpg" crossorigin="anonymous">
    </div>

    <script>
        // --- 1. FULL DATA CONSTANTS (PLATES FLIPPED) ---
        const fleet = [
            {code:"33", model:"Haval Jolion", year:"2022", plate:"2 6 4 9 | ن ا ب", vin:"606889", motor:"21499022758"},
            {code:"38", model:"Chevrolet Aveo", year:"2020", plate:"8 2 6 3 | ب د ع", vin:"E009927", motor:"191160037"},
            {code:"47", model:"Hyundai Tucson", year:"2022", plate:"4 2 6 3 | ب س ه", vin:"KMHJE81BGN", motor:"G4FPNU539488"},
            {code:"48", model:"Jetour X90 Plus", year:"2026", plate:"2 9 1 5 | ب ص ف", vin:"LVTDB21B5TH013984", motor:"SH02227"},
            {code:"34", model:"MG ZS", year:"2025", plate:"5 3 6 5 | س ه ق", vin:"LSJW74U61SZ027362", motor:"3050131"},
            {code:"35", model:"MG ZS", year:"2022", plate:"5 8 5 4 | س ن و", vin:"15665", motor:"130301"},
            {code:"36", model:"MG ZS", year:"2022", plate:"1 6 8 9 | ب ج م", vin:"90006", motor:"71197"},
            {code:"37", model:"MG ZS", year:"2023", plate:"1 4 9 5 | ي ص ر", vin:"LSJW74U35P113013", motor:"15823"},
            {code:"42", model:"MG 5", year:"2026", plate:"7 3 7 8 | س م ه", vin:"LSJA36E95TZ504743", motor:"5130253"},
            {code:"44", model:"MG ZS", year:"2025", plate:"9 4 1 3 | ل و ع", vin:"Lsjw74u69sz012480", motor:"130809"},
            {code:"46", model:"MG 5", year:"2026", plate:"9 5 6 8 | ب ص ف", vin:"Lsja36e91tz511494", motor:"7290206"},
            {code:"40", model:"Nissan Sunny", year:"2023", plate:"7 3 5 1 | ب ه ل", vin:"137137", motor:"798285"},
            {code:"41", model:"Nissan Sunny", year:"2023", plate:"5 7 3 9 | ل ج ق", vin:"P0150253", motor:"751752"},
            {code:"49", model:"Nissan Sunny", year:"2026", plate:"3 5 2 1 | ل س ص", vin:"DA1BBAN17T0195715", motor:"799562N"},
            {code:"43", model:"Renualt Duster", year:"2025", plate:"5 9 4 9 | ص ع د", vin:"VFIHJD208SA107071", motor:"50063"}
        ];

        const termsText = {
            1: `* <strong>Minimum Age:</strong> You must be 21 years or older.<br>* <strong>License:</strong> You must hold a valid driving license for at least 1 year.<br>* <strong>Documents:</strong> Valid ID (or Passport for foreigners) and a Driving License accepted in Egypt are mandatory.<br>* <strong>Authorized Drivers:</strong> Only the person named on the contract may drive. Additional drivers must be approved and listed.`,
            2: `* <strong>24-Hour Cycle:</strong> Rental charges are calculated based on 24-hour units.<br>* <strong>Grace Period:</strong> A maximum grace period of 1 hour is allowed. Returns later than 1 hour will be charged a full day’s rent.<br>* <strong>Extensions:</strong> Any extension must be approved by the Company. Unauthorized late returns are charged at a higher local tariff.<br>* <strong>Early Return:</strong> No refunds are issued for vehicles returned early (Non-refundable).`,
            3: `* <strong>Free Cancellation:</strong> Full refund if cancelled more than 48 hours before pickup.<br>* <strong>Late Cancellation (<48h):</strong> If cancelled less than 48 hours before pickup, 30% of the booking value is retained.<br>* <strong>No Show:</strong> Failure to pick up the car without prior notice results in a 100% forfeiture of the booking amount.`,
            4: `* <strong>Mileage Limit:</strong> Standard limit is 120 KM/day (unless Unlimited KM is purchased). Extra KM is charged upon return.<br>* <strong>Delivery Locations:</strong> Delivery is available to Hotels and Airports. We do not deliver to private accommodation.<br>* <strong>One-Way Rental:</strong> Dropping off at a different branch incurs a specific fee based on distance.`,
            6: `* <strong>Theft Policy:</strong> Theft is <strong>NOT</strong> covered by insurance. The vehicle is the Lessee's sole responsibility and must be parked in secure locations.`,
            7: `Insurance is considered <strong>NULL AND VOID</strong> (Lessee pays 100% of all costs) in the following cases:<br>1. Failure to provide an official <strong>Police Report</strong> immediately after an accident.<br>2. Driving under the influence of alcohol or drugs.<br>3. Driving off-road (Safari) or on unpaved roads.<br>4. Driving by an unauthorized person.<br>5. Gross negligence (e.g., failing to engage handbrake).`,
            8: `The following items are NOT covered by any insurance plan. Lessee agrees to pay:<br>* <strong>Loss of Car Key:</strong> $400 USD (or equivalent EGP).<br>* <strong>License Loss:</strong> $250 USD.<br>* <strong>Spare Tire/Tools:</strong> $300 USD.<br>* <strong>Fire Extinguisher:</strong> $200 USD.<br>* <strong>Tire Damage:</strong> $200 USD per tire.<br>* <strong>Interior Damage:</strong> $100 - $1,000 USD.<br>* <strong>Dirty Return:</strong> Minimum $10 USD (350 EGP).`,
            9: `* <strong>Deposit Block:</strong> A security amount is blocked/paid at pickup to cover excess liability, fuel, and fines.<br>* <strong>Refund Policy:</strong> Deposit is 100% refundable upon safe return of the vehicle in original condition.<br>* <strong>Refund Method:</strong> Deposit is returned in the same currency mix as received. If paid by Card, it is refunded in EGP CASH to avoid bank delays.<br>* <strong>Release Time:</strong> Released only after the Handover Inspection Report is signed and closed.`,
            10: `If there is a disagreement regarding the COST or TIME of repair, we follow this strict protocol:<br><strong>Step 1: Independent Evaluation.</strong> The vehicle will be assessed by an authorized, independent Car Service Center. Their quotation is final.<br><strong>Step 2: Liability.</strong> The at-fault party pays the Repair Cost + Lost Rental Days + Inspection Fee.<br><strong>Step 3: Legal.</strong> Unresolved disputes are referred to the Competent Court under Egyptian Law.`,
            11: `The Lessee is fully responsible for any traffic violations (Speeding, Parking, Radar). The Company reserves the right to charge these costs + administrative fees.`,
            12: `In case of breakdown, call the Company immediately. Do not attempt unauthorized repairs. If the breakdown is due to Company fault (Battery/Engine), you pay nothing. If due to negligence (e.g., wrong fuel), Lessee pays all costs.`,
            13: `* <strong>Interior Negligence:</strong> Insurance does NOT cover negligence inside the vehicle (e.g., cigarette burns, stained seats, broken handles).<br>* <strong>Minor Damages:</strong> For small scratches, tire, or glass damage where a Police Report is impractical, the Lessee agrees to pay the repair cost directly to save time.<br>* <strong>Police Report:</strong> If Lessee refuses to settle damages, a Police Report from the accident scene is MANDATORY.`
        };

        const insDetails = {
            "Basic": `<strong>High Deductible.</strong> You pay 100% for Glass, Tires, and Undercarriage damages.<br><strong>INCLUDES:</strong> Standard CDW (Body damage only with excess).<br><strong>EXCLUDES:</strong> All glass, tires, undercarriage, towing, and third party liability.`,
            "Intermediate": `<strong>Reduced Liability.</strong> Client pays 70% of repair costs. Company pays 30%.<br><strong>INCLUDES:</strong> Undercarriage coverage up to 10K EGP.<br><strong>EXCLUDES:</strong> Glass, Tires, and Interior damage.`,
            "Full Protection": `<strong>Zero Deductible (Waiver).</strong> Reduces liability to ZERO for covered items.<br><strong>CAPS:</strong> Roof (20k), Glass (25k), Undercarriage (40k), Tires (4k/tire).<br><strong>EXCLUDES:</strong> Interior damage (saloon), misfueling, or personal possessions.`
        };

        // --- 2. INIT & FETCH RATES ---
        window.onload = function () {
            const sel = document.getElementById('carSelect');
            fleet.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c.code;
                opt.text = `[${c.code}] ${c.model} (${c.year}) - ${c.plate}`;
                sel.add(opt);
            });

            setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

            // Fetch Live Rates
            fetch('https://api.exchangerate-api.com/v4/latest/USD')
                .then(r => r.json()).then(d => {
                    if (d.rates.EGP) {
                        document.getElementById('ex_usd').value = d.rates.EGP.toFixed(2);
                        if (d.rates.EUR) document.getElementById('ex_eur').value = (d.rates.EGP / d.rates.EUR).toFixed(2);
                        calc();
                    }
                }).catch(e => { calc(); });
            setTimeout(calc, 500);
        };

        // --- 3. HELPERS & MATH ---
        function safeVal(id) { var el = document.getElementById(id); return el ? el.value : ""; }
        function safeNum(id) { var el = document.getElementById(id); if (!el || el.value.trim() === "") return 0; return parseFloat(el.value) || 0; }

        function loadCar() {
            const c = fleet.find(x => x.code === safeVal('carSelect'));
            if (c) {
                document.getElementById('manModel').value = c.model;
                document.getElementById('h_plate').value = c.plate;
                document.getElementById('h_year').value = c.year;
                document.getElementById('h_vin').value = c.vin;
                document.getElementById('h_motor').value = c.motor;
                calc();
            }
        }

        function checkType() { document.getElementById('prevCon').style.display = (safeVal('conType') === 'Extension') ? 'block' : 'none'; calc(); }
        function toggleMode() { document.getElementById('lbl_rate').innerText = (safeVal('rentalMode') === 'Monthly') ? "Monthly Rent (EGP)" : "Daily Rent (EGP)"; calc(); }

        function calc() {
            const rateUsd = safeNum('ex_usd') || 50; const rateEur = safeNum('ex_eur') || 54;
            const pStr = safeVal('p_time'); const dStr = safeVal('d_time'); const mode = safeVal('rentalMode');

            let days = 1;
            if (pStr && dStr) {
                const p = new Date(pStr), d = new Date(dStr);
                if (d > p) { days = Math.ceil(Math.abs(d - p) / (1000 * 60 * 60 * 24)); if (days < 1) days = 1; }
            }

            let mult = (mode === "Monthly") ? ((days / 30).toFixed(1) < 1 ? 1 : parseFloat((days / 30).toFixed(1))) : days;

            const r = safeNum('rateRent'), i = safeNum('rateIns'), fee_d = safeNum('fee_del'), fee_c = safeNum('fee_col');

            // ADD ONS (Dynamic Rates)
            let adds = 0; let addOnsList = [];
            if (document.getElementById('add_km').checked) { let rKM = safeNum('rate_km'); adds += rKM; addOnsList.push(`Unl. KM (${rKM})`); }
            if (document.getElementById('add_dr').checked) { let rDR = safeNum('rate_dr'); adds += rDR; addOnsList.push(`Driver (${rDR})`); }
            if (document.getElementById('add_st').checked) { let rST = safeNum('rate_st'); adds += rST; addOnsList.push(`Child Seat (${rST})`); }
            let addOnsStr = addOnsList.length > 0 ? addOnsList.join(", ") : "None";

            let totalRentOnly = (mode === "Monthly") ? (r * mult) + (i * days) + (adds * days) : ((r + i + adds) * mult);
            let totalDue = Math.round(totalRentOnly + fee_d + fee_c);

            let totalRentPaid = Math.round(safeNum('pay_rent_egp') + (safeNum('pay_rent_usd') * rateUsd) + (safeNum('pay_rent_eur') * rateEur) + safeNum('pay_rent_card'));
            let rentPending = totalDue - totalRentPaid;

            let reqDep = safeNum('req_deposit');
            let totalDepPaid = Math.round(safeNum('pay_dep_egp') + (safeNum('pay_dep_usd') * rateUsd) + (safeNum('pay_dep_eur') * rateEur) + safeNum('pay_dep_card'));
            let depPending = reqDep - totalDepPaid;

            // Update UI
            document.getElementById('c_rent').innerText = Math.round(totalRentOnly).toLocaleString();
            document.getElementById('c_fees').innerText = Math.round(fee_d + fee_c).toLocaleString();
            document.getElementById('c_total_preview').innerText = totalDue.toLocaleString() + " EGP";
            document.getElementById('val_total_due').innerText = totalDue.toLocaleString();
            document.getElementById('val_total_paid').innerText = totalRentPaid.toLocaleString();
            document.getElementById('val_dep_req').innerText = reqDep.toLocaleString();
            document.getElementById('val_dep_paid').innerText = totalDepPaid.toLocaleString();

            let rPenEl = document.getElementById('val_rent_pending');
            if (rentPending > 0) rPenEl.innerHTML = `<span style="color:#e74c3c">${rentPending.toLocaleString()} EGP</span>`;
            else if (rentPending < 0) rPenEl.innerHTML = `<span style="color:#2ecc71">+${Math.abs(rentPending).toLocaleString()} EGP</span>`;
            else rPenEl.innerHTML = `<span style="color:white">0 (PAID)</span>`;

            let dPenEl = document.getElementById('val_dep_pending');
            if (depPending > 0) dPenEl.innerHTML = `<span style="color:#e74c3c">${depPending.toLocaleString()} EGP</span>`;
            else if (depPending < 0) dPenEl.innerHTML = `<span style="color:#2ecc71">+${Math.abs(depPending).toLocaleString()} EGP</span>`;
            else dPenEl.innerHTML = `<span style="color:white">0</span>`;

            return { days, mult, r, i, adds, fee_d, fee_c, totalDue, mode, totalRentPaid, rentPending, depPending, reqDep, addOnsStr, totalRentOnly };
        }

        // --- 4. GENERATE CONTRACT HTML ---
        function generatePreview() {
            const c = calc();
            const branchMap = { "HRG": "HRG", "ALX": "ALX", "CAI": "CAI", "RSD": "RSD" };
            const bCode = branchMap[safeVal('issuingBranch')] || "HRG";
            
            // Format dates
            let now = new Date();
            let dStr = String(now.getDate()).padStart(2,'0') + String(now.getMonth()+1).padStart(2,'0');
            let tStr = String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');
            
            const cid = `BR-${bCode}-${dStr}-${tStr}`;
            const today = now.toLocaleDateString('en-GB');

            const usd = safeNum('ex_usd') || 50; const eur = safeNum('ex_eur') || 54;

            const buildPayStr = (pfx) => {
                let egp = safeNum(pfx + '_egp'), u = safeNum(pfx + '_usd'), e = safeNum(pfx + '_eur'), card = safeNum(pfx + '_card');
                let total = egp + (u * usd) + (e * eur) + card;
                let parts = [];
                if (egp > 0) parts.push(egp + " Cash (EGP)"); 
                if (u > 0) parts.push(u + " USD (Rate: " + usd + ")"); 
                if (e > 0) parts.push(e + " EUR (Rate: " + eur + ")"); 
                if (card > 0) parts.push(card + " Card (EGP)");
                let detail = parts.length > 0 ? `(${parts.join(' + ')})` : "";
                return { total: total, text: `<strong>${Math.round(total).toLocaleString()} EGP</strong> <span style="font-size:8.5pt; font-weight:normal;">${detail}</span>`, breakdownDetails: detail };
            };

            let rentInfo = buildPayStr('pay_rent'); let depInfo = buildPayStr('pay_dep');
            let totalDepPaid = safeNum('pay_dep_egp') + (safeNum('pay_dep_usd') * usd) + (safeNum('pay_dep_eur') * eur) + safeNum('pay_dep_card');

            let rateTxt = c.mode === 'Monthly' ? `${c.r} x ${c.mult} Mo` : `${c.r} x ${c.days} Days`;
            let base = c.mode === 'Monthly' ? (c.r * c.mult) : (c.r * c.days);

            let pText = safeVal('p_loc') + (safeVal('p_addr') ? " (" + safeVal('p_addr') + ")" : "");
            let dText = safeVal('d_loc') + (safeVal('d_addr') ? " (" + safeVal('d_addr') + ")" : "");

            const insKey = safeVal('insPack') || "Basic";
            const simpleInsText = {
                "Basic": "Basic Insurance: 100% Client Liability for Damages.",
                "Intermediate": "Intermediate: 70% Client Liability / 30% Company Coverage.",
                "Full Protection": "Full Protection: Zero Deductible (Subject to caps)."
            };
            const insClass = insKey === 'Full Protection' ? 'ins-full' : (insKey === 'Intermediate' ? 'ins-inter' : 'ins-basic');

            const prevCon = safeVal('prevCon');
            const extHtml = safeVal('conType') === 'Extension' ? `<div style="font-size:10pt; font-weight:bold; margin-top:3px;">(EXTENSION TO ${prevCon})</div>` : '';

            // Safe fallback images if network is down
            const logoSrc = "https://brothersegy.com/wp-content/uploads/2025/07/22wdd.jpg";
            const waterSrc = "https://brothersegy.com/wp-content/uploads/2026/02/12345.png";
            const carSrc = "https://brothersegy.com/wp-content/uploads/2026/02/تصميم-هيكل-السيارة-للعقود.jpg";

            let html = ``;

            // --- PAGE 1: CONTRACT ---
            html += `
            <div class="a4-page">
                <div class="watermark"><img src="${waterSrc}"></div>
                <div class="page-content">
                    <div class="doc-head">
                        <img src="${logoSrc}" class="logo">
                        <div style="text-align:center">
                            <h1 style="margin:0; font-size:18pt; color:#04509D">CAR RENTAL AGREEMENT</h1>
                            <div id="preview-cid" style="font-weight:bold; font-size:12pt;">${cid}</div>
                            ${extHtml}
                        </div>
                        <div class="hq-info" style="text-align:right;">
                            <strong>BROTHERS EGY HQ</strong><br>
                            50 Abd Al Latef Al Soufani, Sidi Gabir,<br>Alexandria<br>
                            Tax: 589-464-418 | CR: 10770<br>
                            Branch: ${safeVal('issuingBranch')}
                        </div>
                    </div>

                    <div class="box-section"><span class="bs-title">PARTIES</span>
                        <table class="pt" style="margin:0">
                            <tr><td width="30%"><strong>LESSOR</strong><br>El Alakhua El Mutahidun<br>${safeVal('issuingBranch')} Branch</td>
                                <td><strong>LESSEE</strong><br>
                                <b>Name:</b> ${safeVal('cl_fname')} ${safeVal('cl_sname')}<br>
                                <b>Passport / ID:</b> ${safeVal('cl_pass')} | <b>License No:</b> ${safeVal('cl_lic')} | <b>Nation:</b> ${safeVal('cl_nation')}<br>
                                <b>Phone:</b> ${safeVal('cl_ph_code')} ${safeVal('cl_phone')} | <b>Addr:</b> ${safeVal('cl_addr')}<br>
                                ${safeVal('cl_add_driver') ? '<b>Add. Driver:</b> ' + safeVal('cl_add_driver') : ''}</td></tr>
                        </table>
                    </div>

                    <div class="box-section"><span class="bs-title">VEHICLE & PERIOD</span>
                        <table class="pt">
                            <tr><th>Model</th><td>${safeVal('manModel')}</td><th>Plate</th><td dir="ltr" style="text-align:right;"><b>${safeVal('h_plate')}</b></td><th>KM Out</th><td>${safeVal('kmOut')}</td></tr>
                            <tr><th>VIN</th><td>${safeVal('h_vin')}</td><th>Motor</th><td>${safeVal('h_motor')}</td><th>Allow</th><td>${document.getElementById('add_km').checked ? "Unlimited" : (120 * c.days) + " KM"}</td></tr>
                            <tr><th>Pickup</th><td>${safeVal('p_time').replace('T', ' ')}<br>${pText}</td>
                                <th>Dropoff</th><td>${safeVal('d_time').replace('T', ' ')}<br>${dText}</td>
                                <th>Duration</th><td>${c.days} Days</td></tr>
                        </table>
                    </div>

                    <div class="box-section"><span class="bs-title">FINANCIAL BREAKDOWN</span>
                        <table class="pt">
                            <tr><th>Item Description</th><th>Rate / Calculation</th><th style="text-align:right">Amount (EGP)</th></tr>
                            <tr><td>Base Rent</td><td>${rateTxt}</td><td align="right">${Math.round(base).toLocaleString()}</td></tr>
                            ${c.i > 0 ? `<tr><td>Insurance Fees</td><td>${c.i} x ${c.days} Days</td><td align="right">${(c.i * c.days).toLocaleString()}</td></tr>` : ''}
                            ${c.adds > 0 ? `<tr><td>Add-ons (${c.addOnsStr})</td><td>${c.adds} x ${c.days} Days</td><td align="right">${(c.adds * c.days).toLocaleString()}</td></tr>` : ''}
                            ${c.fee_d > 0 ? `<tr><td>Delivery Fee (${pText})</td><td>Fixed</td><td align="right">${c.fee_d}</td></tr>` : ''}
                            ${c.fee_c > 0 ? `<tr><td>Pickup Fee (${dText})</td><td>Fixed</td><td align="right">${c.fee_c}</td></tr>` : ''}
                            <tr style="font-weight:bold; border-top:2px solid #000;"><td colspan="2" align="right">TOTAL CONTRACT VALUE:</td><td align="right">${Math.round(c.totalDue).toLocaleString()} EGP</td></tr>
                        </table>
                        <div class="${insClass}" style="border:1px solid #000; padding:5px; text-align:center; font-size:9pt; margin-bottom:5px; border-radius:4px;">
                            ${simpleInsText[insKey]}
                        </div>
                        <div style="background:#eee; padding:5px; text-align:center;">
                            PAID NOW: ${rentInfo.text} <br> <span style="color:${c.rentPending > 0 ? '#c0392b' : '#27ae60'}; font-weight:bold;">PENDING: ${Math.round(c.rentPending).toLocaleString()} EGP</span>
                        </div>
                    </div>

                    ${(c.reqDep > 0 || totalDepPaid > 0) ? `
                    <div style="border:2px solid orange; padding:5px; margin-bottom:10px; font-size:9pt;">
                        <strong>DEPOSIT HELD:</strong> ${depInfo.text} 
                        <span style="float:right; font-weight:bold; color:${c.depPending > 0 ? '#c0392b' : '#27ae60'}">${c.depPending > 0 ? Math.round(c.depPending) + ' EGP PENDING' : 'FULLY HELD'}</span>
                    </div>` : ''}
                    
                     <div style="text-align:center; border:2px dashed #000; padding:10px; font-size:9pt; margin-top:10px;">
                        <strong>IMPORTANT:</strong> Contract is void for any period NOT covered by an official payment receipt.<br>
                        <strong>LIABILITY:</strong> If the RETURN CHECK is not closed/signed, the Lessee retains full liability for the vehicle until official closure.
                        The Lessee bears full legal and criminal liability for the rented vehicle during the entire rental period.
                    </div>

                    <div style="margin-top:auto; border-top:2px solid #000; padding-top:10px; margin-bottom: 30px;">
                        <div style="display:flex; justify-content:space-between; text-align:center; font-weight:bold; font-size:10pt;">
                            <div style="width:40%;">LESSOR SIGNATURE<br><br><br>____________________<div style="font-size:9pt; margin-top:5px;">Date: ........................</div></div>
                             <div style="width:40%;">LESSEE SIGNATURE<br><br><br>____________________<div style="font-size:9pt; margin-top:5px;">Date: ........................</div></div>
                        </div>
                    </div>
                </div>
            </div>`;

            // --- PAGE 2: TERMS ---
            const insContent = insDetails[insKey] || insDetails["Basic"];

            html += `
            <div class="a4-page">
                <div class="watermark"><img src="${waterSrc}"></div>
                <div class="page-content">
                    <div class="doc-head"><strong>TERMS & CONDITIONS</strong><span>Page 2/4</span></div>
                    <div class="terms-grid">
                        <div class="term-p"><span class="term-h">1. DRIVER REQUIREMENTS & ELIGIBILITY</span>${termsText[1]}</div>
                        <div class="term-p"><span class="term-h">2. RENTAL PERIOD & EXTENSIONS</span>${termsText[2]}</div>
                        <div class="term-p"><span class="term-h">3. CANCELLATION & NO-SHOW POLICY</span>${termsText[3]}</div>
                        <div class="term-p"><span class="term-h">4. DELIVERY & MILEAGE</span>${termsText[4]}</div>

                        <div class="term-p" style="border:2px solid #e67e22; padding:5px; background:#fff8e1; break-inside:avoid;">
                            <span class="term-h" style="color:#e67e22; border-bottom-color:#e67e22;">5. YOUR INSURANCE PACKAGE: ${insKey.toUpperCase()}</span>
                            <div style="font-weight:normal; font-size:8pt; margin-top:5px; line-height:1.3;">${insContent}</div>
                        </div>
                        
                        <div class="term-p"><span class="term-h">6. THEFT & LOSS WAIVER</span>${termsText[6]}</div>
                        <div class="term-p"><span class="term-h">7. VOIDING OF INSURANCE</span>${termsText[7]}</div>
                        <div class="term-p"><span class="term-h">8. SCHEDULE OF PENALTIES (NEGLIGENCE)</span>${termsText[8]}</div>
                        <div class="term-p"><span class="term-h">9. SECURITY DEPOSIT & REFUNDS</span>${termsText[9]}</div>
                        <div class="term-p"><span class="term-h">10. DISPUTE RESOLUTION</span>${termsText[10]}</div>
                        <div class="term-p"><span class="term-h">11. TRAFFIC FINES</span>${termsText[11]}</div>
                        <div class="term-p"><span class="term-h">12. MECHANICAL DIFFICULTIES</span>${termsText[12]}</div>
                        <div class="term-p"><span class="term-h">13. INSURANCE & LIABILITY NOTICES</span>${termsText[13]}</div>
                    </div>
                    <div style="margin-top:auto; padding:15px; border-top:1px solid #000; font-weight:bold; text-align:center;">
                        <strong>I have read and accepted all terms & conditions.</strong> <br><br><br> Signature: __________________________
                        <div style="font-size:9pt; margin-top:5px;">Date: ........................</div>
                    </div>
                </div>
            </div>`;

            // --- PAGE 3: INSPECTION ---
            const chkRow = (lbl) => `
                <div class="v-insp-row">
                    <span class="v-label">${lbl}</span>
                    <div class="v-check-group">
                        <div class="v-check-box v-green"></div><div class="v-check-box v-red"></div>
                    </div>
                </div>`;
            
            const checklistGroups = `
                <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                    <div style="width:48%;"><div class="insp-group-head">PASSENGER</div>${chkRow('(D) FEND F')}${chkRow('(L) DOOR F')}${chkRow('(K) DOOR R')}${chkRow('(J) FEND R')}</div>
                    <div style="width:48%;"><div class="insp-group-head">FRONT</div>${chkRow('(E) BUMPER')}${chkRow('(F) HOOD')}${chkRow('(W) WINDSH')}</div>
                    <div style="width:48%;"><div class="insp-group-head">REAR</div>${chkRow('(Q) TRUNK')}${chkRow('(H) BUMPER')}${chkRow('(I) LIGHTS')}</div>
                    <div style="width:48%;"><div class="insp-group-head">DRIVER</div>${chkRow('(M) FEND F')}${chkRow('(C) DOOR F')}${chkRow('(B) DOOR R')}${chkRow('(A) FEND R')}</div>
                </div>`;

            let kmAllowedTotal = document.getElementById('add_km').checked ? "Unlimited" : (parseInt(safeVal('kmOut') || 0) + (120 * c.days));

            let pickupHtmlClean = `
                <div class="insp-left-col">
                    <div class="insp-section-head">PICKUP CHECK (Start of Rental)</div>
                    <div class="box-section" style="padding:2px; margin-bottom:5px;">
                        <table class="pt" style="font-size:7pt; margin-bottom:0;">
                            <tr style="background:#eee;"><th>KM OUT</th><td align="center">${safeVal('kmOut')}</td></tr>
                            <tr style="background:#eee;"><th>FUEL LEVEL</th><td align="center">${safeVal('fuelOut')}</td></tr>
                        </table>
                    </div>
                    <div style="text-align:center; font-size:7pt; font-weight:bold;">EXISTING DAMAGES:</div>
                    <div class="car-img-container"><img src="${carSrc}"></div>
                    <div class="tire-img-wrapper">
                        <div class="tire-img-container"><img src="https://brothersegy.com/wp-content/uploads/2026/02/wheel-tyre-illustration-png.png"></div>
                        <div style="font-size:7pt;"><strong>TIRE:</strong> _________________</div>
                    </div>
                    ${checklistGroups}
                    <div style="margin-top:5px; border:1px solid #ccc; padding:2px; min-height:40px;">
                        <div style="font-size:7pt; font-weight:bold;">NOTES / ACCESSORIES:</div>
                        <div style="font-size:7pt;">Spare Tire [ ] Jack [ ] Fire Ext [ ] Triangle [ ]</div>
                    </div>
                </div>`;

            const returnHtml = `
                <div class="insp-right-col">
                    <div class="insp-section-head">RETURN CHECK (End of Rental)</div>
                    <div class="box-section" style="padding:2px; margin-bottom:5px;">
                         <table class="pt" style="font-size:7pt; margin-bottom:0;">
                            <tr style="background:#eee;"><th>KM IN (${kmAllowedTotal} Max)</th><td><br>__________________</td></tr>
                            <tr style="background:#eee;"><th>FUEL LEVEL</th><td><span style="font-size:7pt;">[ ] Full [ ] 3/4 [ ] 1/2 [ ] 1/4 [ ] Empty</span></td></tr>
                         </table>
                    </div>
                    <div style="text-align:center; font-size:7pt; font-weight:bold;">MARK NEW DAMAGES:</div>
                    <div class="car-img-container"><img src="${carSrc}"></div>
                    <div class="tire-img-wrapper">
                        <div class="tire-img-container"><img src="https://brothersegy.com/wp-content/uploads/2026/02/wheel-tyre-illustration-png.png"></div>
                        <div style="font-size:7pt;"><strong>TIRE:</strong> _________________</div>
                    </div>
                    ${checklistGroups}
                    <div class="box-section" style="margin-top:5px; margin-bottom:2px; padding:2px;">
                        <span class="bs-title" style="font-size:7pt;">FINAL SETTLEMENT</span>
                        <table class="pt" style="font-size:8pt; margin-bottom:0;">
                            <tr><th width="45%">Item Description</th><th width="30%">Rate x Qty</th><th width="25%">Total (EGP)</th></tr> 
                            <tr><td>Excess KM</td><td align="center">_______ x _______</td><td align="right">___________</td></tr>
                            <tr><td>Late Return</td><td align="center">_______ x _______</td><td align="right">___________</td></tr>
                            <tr><td>Cleaning Fees</td><td align="center">-</td><td align="right">___________</td></tr>
                            <tr><td>Fuel Shortage</td><td align="center">-</td><td align="right">___________</td></tr>
                            <tr><td>Traffic Fines</td><td align="center">-</td><td align="right">___________</td></tr>
                            <tr><td>New Damages</td><td align="center">-</td><td align="right">___________</td></tr>
                            <tr style="font-weight:bold; background:#eee;"><td colspan="2" align="right">TOTAL DEDUCTIONS:</td><td align="right">___________ EGP</td></tr>
                        </table>
                    </div>
                    <div style="font-size:7.5pt; font-weight:bold; margin-top:5px; border:1px solid #000; padding:3px; background:#fff3e0;">
                        IMPORTANT: If the RETURN CHECK is not closed/signed, the Lessee retains full liability.
                    </div>
                </div>`;

            html += `
            <div class="a4-page">
                <div class="watermark"><img src="${waterSrc}"></div>
                <div class="page-content">
                    <div class="doc-head"><strong>VISUAL INSPECTION REPORT</strong><span>Page 3/4</span></div>
                    <div style="font-size:8pt; text-align:center; font-weight:bold; margin-bottom:5px;">Contract: ${cid} | Date: ${today}</div>
                    
                    <div class="insp-two-col">
                        ${pickupHtmlClean}
                        ${returnHtml}
                    </div>

                    <div style="margin-top:auto; border-top:2px solid #000; padding-top:10px;">
                        <div style="display:flex; justify-content:space-between; text-align:center; font-weight:bold; font-size:10pt;">
                            <div style="width:30%;">PICKUP: Lessee<br><br><br><br>____________________<div style="font-size:8pt; margin-top:5px;">Date: ........................</div></div>
                            <div style="width:30%;">RETURN: Lessee<br><br><br><br>____________________<div style="font-size:8pt; margin-top:5px;">Date: ........................</div></div>
                            <div style="width:30%;">RETURN: Employee<br><br><br><br>____________________</div>
                        </div>
                    </div>
                </div>
            </div>`;

            // --- PAGE 4+: RECEIPTS ---
            const recData = {
                client: `${safeVal('cl_fname')} ${safeVal('cl_sname')}`, 
                pass: safeVal('cl_pass'),
                phone: `${safeVal('cl_ph_code')} ${safeVal('cl_phone')}`, 
                con: cid,
                car: `${safeVal('manModel')} (${safeVal('h_year')}) | Plate: ${safeVal('h_plate')}`
            };

            const singleRecHtml = (title, copyType, amountStr, details, isBlankDate = false, periodStr = "", isDeposit = false) => `
                <div class="receipt-half">
                    <div class="rec-header">
                        <table style="width:100%; border-collapse:collapse;">
                            <tr>
                                <td width="20%"><img src="${logoSrc}" style="height:45px; object-fit:contain;"></td>
                                <td width="60%" align="center">
                                    <div class="rec-title">OFFICIAL RECEIPT</div>
                                    <div style="font-size:9pt;">${copyType}</div>
                                </td>
                                <td width="20%" align="right"><img src="https://api.qrserver.com/v1/create-qr-code/?data=https://brothersegy.com&size=80x80" style="height:45px;"></td>
                            </tr>
                        </table>
                        <div style="text-align:right; font-size:9pt; margin-top:5px;">DATE: ${isBlankDate ? "___/___/202_" : today}</div>
                        <div style="text-align:right; font-weight:bold;">${title}</div>
                    </div>
                    
                    <div class="rec-body-grid">
                        <div class="rec-col">
                            <div class="rec-row"><span class="rec-label">RECEIVED FROM</span><span class="rec-val">${recData.client}</span></div>
                            <div class="rec-row"><span class="rec-label">PASSPORT / ID</span><span class="rec-val">${recData.pass || '-'}</span></div>
                            <div class="rec-row"><span class="rec-label">PHONE</span><span class="rec-val">${recData.phone}</span></div>
                        </div>
                        <div class="rec-col">
                            <div class="rec-row"><span class="rec-label">CONTRACT NO</span><span class="rec-val">${recData.con}</span></div>
                            <div class="rec-row"><span class="rec-label">VEHICLE</span><span class="rec-val" dir="ltr" style="text-align:right;">${recData.car}</span></div>
                            ${isDeposit ? '' : `<div class="rec-row"><span class="rec-label">PERIOD</span><span class="rec-val" style="font-size:8pt;">${periodStr}</span></div>`}
                        </div>
                    </div>

                    <div class="rec-amount-box">
                        <div class="rec-amount-row">
                            <span class="rec-amount-lbl">AMOUNT RECEIVED</span>
                            <span class="rec-amount-val">${isBlankDate ? "____________ EGP" : amountStr}</span>
                        </div>
                        <div class="rec-amount-row" style="margin-bottom:0;">
                            <span class="rec-amount-lbl" style="font-size:8pt;">PAYMENT DETAILS</span>
                            <span class="rec-val" style="font-size:8pt; font-weight:normal;">${isBlankDate ? "________________________" : details}</span>
                        </div>
                    </div>
                    
                    <div style="font-size:7pt; color:#666; margin-top:5px;">
                        ${isDeposit ? "<strong style='color:#c0392b;'>* Fully refundable if returned in same condition. Deductions apply for damages/fines.</strong><br>" : "<strong>Breakdown:</strong> Base Tariff + Added Services (Insurance, Delivery, Logistics).<br>"}
                        ${!isDeposit && c.rentPending > 0 ? `<span style="color:#c0392b; font-weight:bold;">⚠ OUTSTANDING BALANCE: ${Math.round(c.rentPending).toLocaleString()} EGP</span>` : ''}
                    </div>
                    <div class="rec-footer" style="padding-top:10px;">
                         <div style="display:flex; justify-content:space-between; align-items:flex-end; width:100%;">
                            <div style="flex-grow:1;"></div>
                            <div class="rec-sig-line">AUTHORIZED SIGNATURE<div style="font-size:8pt; margin-top:2px;">Date: ........................</div></div>
                        </div>
                    </div>
                </div>`;

            // DYNAMIC RENTAL RECEIPTS LOOP
            let loopCount = (c.mode === 'Monthly') ? Math.ceil(c.days / 30) : 1;
            let sDate = new Date(safeVal('p_time'));
            if (isNaN(sDate)) sDate = new Date();
            
            let finalDropoffDate = new Date(safeVal('d_time'));
            if (isNaN(finalDropoffDate)) finalDropoffDate = new Date(sDate.getTime() + (c.days * 24 * 60 * 60 * 1000));
            
            let monthlyAmount = c.mult > 0 ? Math.round(c.totalRentOnly / c.mult) : c.totalRentOnly;

            for(let j=1; j<=loopCount; j++) {
                let eDate = new Date(sDate);
                if(c.mode === 'Monthly') {
                    eDate.setMonth(eDate.getMonth() + 1);
                    if (eDate > finalDropoffDate) eDate = finalDropoffDate; // Cap at final dropoff
                } else {
                    eDate = finalDropoffDate;
                }
                
                let sStr = sDate.toLocaleDateString('en-GB');
                let eStr = eDate.toLocaleDateString('en-GB');
                let pStr = `${sStr} to ${eStr}`;

                let isFirst = (j === 1);
                
                let amtStr = isFirst ? (Math.round(c.totalRentPaid).toLocaleString() + " EGP") : (Math.round(monthlyAmount).toLocaleString() + " EGP");
                let detStr = isFirst ? rentInfo.breakdownDetails : "________________________";
                let isBlankDate = !isFirst;

                let loopTitle = (c.mode === 'Monthly') ? `RENTAL PAYMENT (Month ${j})` : `RENTAL PAYMENT`;

                html += `
                <div class="a4-page">
                    <div class="page-content">
                        ${singleRecHtml(loopTitle, 'CLIENT COPY', amtStr, detStr, isBlankDate, pStr, false)}
                        <div style="text-align:center; border-top:1px dashed #999; color:#999; padding: 10px 0;">- - - - - DETACH HERE - - - - -</div>
                        ${singleRecHtml(loopTitle, 'COMPANY COPY', amtStr, detStr, isBlankDate, pStr, false)}
                    </div>
                </div>`;
                sDate = eDate;
            }

            // DEPOSIT RECEIPT
            if (c.reqDep > 0 || totalDepPaid > 0) {
                let depAmtStr = Math.round(totalDepPaid > 0 ? totalDepPaid : c.reqDep).toLocaleString() + " EGP";
                html += `
                <div class="a4-page">
                    <div class="page-content">
                        ${singleRecHtml('SECURITY DEPOSIT', 'CLIENT COPY', depAmtStr, depInfo.breakdownDetails || "Pending", totalDepPaid <= 0, "", true)}
                        <div style="text-align:center; border-top:1px dashed #999; color:#999; padding: 10px 0;">- - - - - DETACH HERE - - - - -</div>
                        ${singleRecHtml('SECURITY DEPOSIT', 'COMPANY COPY', depAmtStr, depInfo.breakdownDetails || "Pending", totalDepPaid <= 0, "", true)}
                    </div>
                </div>`;
            }

            document.getElementById('contractOutput').innerHTML = html;
            document.getElementById('contractOutput').style.display = "block";
            document.getElementById('btnRealPrint').style.display = "block";
            
            setTimeout(() => {
                document.getElementById('btnRealPrint').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // PRINT HANDLER
        function printContract() {
            // Temporarily set document title to Contract ID to ensure PDF saves with correct name
            const oldTitle = document.title;
            const cidEl = document.getElementById('preview-cid');
            if (cidEl) {
                document.title = cidEl.innerText;
            }
            window.print();
            document.title = oldTitle; // Restore
        }
    </script>
</body>
</html>
